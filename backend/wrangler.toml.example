# ========================================
# Inkweld Cloudflare Workers Configuration
# ========================================
#
# QUICK SETUP (from project root):
#   npm run cloudflare:setup
#
# MANUAL SETUP:
#
# 1. Copy this file:
#    cp wrangler.toml.example wrangler.toml
#
# 2. Login to Cloudflare:
#    npx wrangler login
#
# 3. Create your D1 databases:
#    npx wrangler d1 create inkweld_dev
#    npx wrangler d1 create inkweld_prod
#
# 4. Copy the database_id values from the output into this file
#    (look for the [[env.dev.d1_databases]] and [[env.production.d1_databases]] sections)
#
# 5. Set secrets (from backend directory):
#    echo "your-session-secret-at-least-32-chars" | npx wrangler secret put SESSION_SECRET --env dev
#    echo "your-session-secret-at-least-32-chars" | npx wrangler secret put SESSION_SECRET --env production
#
# 6. Run migrations (from backend directory):
#    npx wrangler d1 execute inkweld_dev --file=./drizzle/0000_safe_mysterio.sql
#    npx wrangler d1 execute inkweld_prod --file=./drizzle/0000_safe_mysterio.sql
#
# 7. Deploy (from project root):
#    npm run cloudflare:deploy:dev   # Development
#    npm run cloudflare:deploy:prod  # Production
#
# For more details, see: docs/site/docs/hosting/cloudflare.md
# ========================================

name = "inkweld-backend"
main = "src/cloudflare-runner.ts"
compatibility_date = "2025-01-01"
compatibility_flags = ["nodejs_compat"]

# Note: The top-level configuration is for local development with wrangler dev.
# For actual deployments, use --env dev or --env production.

workers_dev = true

[build]
command = ""

# ========================================
# LOCAL DEVELOPMENT (wrangler dev --local)
# ========================================
# These settings are used when running `wrangler dev` locally.
# They use placeholder values that don't require Cloudflare resources.

[vars]
NODE_ENV = "development"
PORT = "8333"
DB_TYPE = "d1"
ALLOWED_ORIGINS = "http://localhost:4200,http://localhost:4400"
USER_APPROVAL_REQUIRED = "false"
GITHUB_ENABLED = "false"
RECAPTCHA_ENABLED = "false"
SESSION_SECRET = "local-dev-session-secret-for-testing-minimum-32-chars"

[[d1_databases]]
binding = "DB"
database_name = "inkweld_local"
database_id = "local"  # Wrangler creates a local SQLite for dev

[[durable_objects.bindings]]
name = "YJS_PROJECTS"
class_name = "YjsProject"
script_name = "inkweld-backend"

[[migrations]]
tag = "v1"
new_sqlite_classes = ["YjsProject"]

# ========================================
# DEVELOPMENT ENVIRONMENT (--env dev)
# ========================================
# Deploy with: bun run deploy:dev (or wrangler deploy --env dev)
# This deploys to inkweld-backend-dev.your-subdomain.workers.dev

[env.dev]
name = "inkweld-backend-dev"

[env.dev.vars]
NODE_ENV = "development"
PORT = "8333"
DB_TYPE = "d1"
ALLOWED_ORIGINS = "http://localhost:4200,http://localhost:4400,https://inkweld.app"
USER_APPROVAL_REQUIRED = "false"
GITHUB_ENABLED = "false"
RECAPTCHA_ENABLED = "false"

# TODO: Replace with your actual D1 database ID
# Create with: npx wrangler d1 create inkweld_dev
# Then copy the database_id from the output
[[env.dev.d1_databases]]
binding = "DB"
database_name = "inkweld_dev"
database_id = "YOUR_DEV_DATABASE_ID_HERE"  # <-- REPLACE THIS

# Optional: R2 storage for file uploads
# Create with: npx wrangler r2 bucket create inkweld-storage-dev
# [[env.dev.r2_buckets]]
# binding = "STORAGE"
# bucket_name = "inkweld-storage-dev"

[[env.dev.durable_objects.bindings]]
name = "YJS_PROJECTS"
class_name = "YjsProject"
script_name = "inkweld-backend-dev"

# ========================================
# PRODUCTION ENVIRONMENT (--env production)
# ========================================
# Deploy with: bun run deploy:prod (or wrangler deploy --env production)
# This deploys to inkweld-backend-prod.your-subdomain.workers.dev

[env.production]
name = "inkweld-backend-prod"

[env.production.vars]
NODE_ENV = "production"
PORT = "8333"
DB_TYPE = "d1"
ALLOWED_ORIGINS = "https://inkweld.app"  # Update with your production domain
USER_APPROVAL_REQUIRED = "true"
GITHUB_ENABLED = "false"
RECAPTCHA_ENABLED = "false"

# TODO: Replace with your actual D1 database ID
# Create with: npx wrangler d1 create inkweld_prod
# Then copy the database_id from the output
[[env.production.d1_databases]]
binding = "DB"
database_name = "inkweld_prod"
database_id = "YOUR_PROD_DATABASE_ID_HERE"  # <-- REPLACE THIS

# Optional: R2 storage for file uploads
# Create with: npx wrangler r2 bucket create inkweld-storage
# [[env.production.r2_buckets]]
# binding = "STORAGE"
# bucket_name = "inkweld-storage"

[[env.production.durable_objects.bindings]]
name = "YJS_PROJECTS"
class_name = "YjsProject"
script_name = "inkweld-backend-prod"

# ========================================
# SECRETS (set via wrangler secret put)
# ========================================
# Required secrets for each environment:
#   SESSION_SECRET - Session encryption key (32+ characters)
#
# Optional secrets (if features enabled):
#   GITHUB_CLIENT_ID - GitHub OAuth client ID
#   GITHUB_CLIENT_SECRET - GitHub OAuth client secret
#   RECAPTCHA_SITE_KEY - reCAPTCHA site key
#   RECAPTCHA_SECRET_KEY - reCAPTCHA secret key
#
# Set with:
#   echo "value" | npx wrangler secret put SECRET_NAME --env dev
#   echo "value" | npx wrangler secret put SECRET_NAME --env production
