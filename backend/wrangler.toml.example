# ========================================
# Inkweld Cloudflare Workers Configuration
# ========================================
#
# QUICK SETUP (from project root):
#   npm run cloudflare:setup
#
# ENVIRONMENTS:
#   - Local dev:   wrangler dev (uses local SQLite, no cloud resources)
#   - Staging:     --env staging (deploys to Cloudflare for testing)
#   - Production:  --env production (live environment)
#
# MANUAL SETUP:
#
# 1. Copy this file:
#    cp wrangler.toml.example wrangler.toml
#
# 2. Login to Cloudflare:
#    npx wrangler login
#
# 3. Create D1 database(s):
#    npx wrangler d1 create inkweld_staging   # Optional
#    npx wrangler d1 create inkweld_prod      # Required for production
#
# 4. Update the database_id values in the env sections below
#
# 5. Set secrets (from backend directory):
#    npx wrangler secret put SESSION_SECRET --env staging
#    npx wrangler secret put SESSION_SECRET --env production
#
# 6. Run migrations (from backend directory):
#    npx wrangler d1 execute inkweld_staging --file=./drizzle/0000_safe_mysterio.sql
#    npx wrangler d1 execute inkweld_prod --file=./drizzle/0000_safe_mysterio.sql
#
# 7. Deploy (from project root):
#    npm run cloudflare:deploy:staging   # Staging
#    npm run cloudflare:deploy:prod      # Production
#
# For more details, see: docs/site/docs/hosting/cloudflare.md
# ========================================

name = "inkweld-backend"
main = "src/cloudflare-runner.ts"
compatibility_date = "2025-01-01"
compatibility_flags = ["nodejs_compat"]

workers_dev = true

[build]
command = ""

# ========================================
# LOCAL DEVELOPMENT (wrangler dev)
# ========================================
# Run with: wrangler dev (from backend directory)
# Uses local SQLite - no Cloudflare resources needed.

[vars]
NODE_ENV = "development"
PORT = "8333"
DB_TYPE = "d1"
ALLOWED_ORIGINS = "http://localhost:4200,http://localhost:4400"
USER_APPROVAL_REQUIRED = "false"
GITHUB_ENABLED = "false"
SESSION_SECRET = "local-dev-session-secret-for-testing-minimum-32-chars"

[[d1_databases]]
binding = "DB"
database_name = "inkweld_local"
database_id = "local"  # Wrangler creates a local SQLite automatically
migrations_dir = "drizzle"

[[durable_objects.bindings]]
name = "YJS_PROJECTS"
class_name = "YjsProject"
script_name = "inkweld-backend"

[[migrations]]
tag = "v1"
new_sqlite_classes = ["YjsProject"]

# ========================================
# STAGING ENVIRONMENT (--env staging)
# ========================================
# Deploy with: npm run cloudflare:deploy:staging
# A pre-production environment for testing on real Cloudflare infrastructure.
# Skip this if you only need production.

[env.staging]
name = "inkweld-backend-staging"

# Custom domain for staging backend (optional)
# Uncomment and set your domain. Requires domain to be added to Cloudflare.
# See: https://developers.cloudflare.com/workers/configuration/routing/custom-domains/
# routes = [{ pattern = "api.staging.yourdomain.com", custom_domain = true }]

[env.staging.vars]
NODE_ENV = "staging"
PORT = "8333"
DB_TYPE = "d1"
# Include *.your-pages-project.pages.dev to allow deployment preview URLs
ALLOWED_ORIGINS = "http://localhost:4200,https://staging.yourdomain.com,*.your-pages-project-staging.pages.dev"
USER_APPROVAL_REQUIRED = "false"
GITHUB_ENABLED = "false"
SESSION_SECRET = "placeholder-set-via-wrangler-secret-put"  # Overridden by secret

# Create with: npx wrangler d1 create inkweld_staging
[[env.staging.d1_databases]]
binding = "DB"
database_name = "inkweld_staging"
database_id = "YOUR_STAGING_DATABASE_ID_HERE"  # <-- REPLACE THIS
migrations_dir = "drizzle"

# R2 storage for media files (covers, avatars, inline images)
# Create with: npx wrangler r2 bucket create inkweld-storage-staging
[[env.staging.r2_buckets]]
binding = "STORAGE"
bucket_name = "inkweld-storage-staging"

[[env.staging.durable_objects.bindings]]
name = "YJS_PROJECTS"
class_name = "YjsProject"
script_name = "inkweld-backend-staging"

# ========================================
# PRODUCTION ENVIRONMENT (--env production)
# ========================================
# Deploy with: npm run cloudflare:deploy:prod
# Your live production environment.

[env.production]
name = "inkweld-backend-prod"

# Custom domain for production backend (optional)
# Uncomment and set your domain. Requires domain to be added to Cloudflare.
# See: https://developers.cloudflare.com/workers/configuration/routing/custom-domains/
# routes = [{ pattern = "api.yourdomain.com", custom_domain = true }]

[env.production.vars]
NODE_ENV = "production"
PORT = "8333"
DB_TYPE = "d1"
# Include *.your-pages-project.pages.dev to allow deployment preview URLs
ALLOWED_ORIGINS = "https://yourdomain.com,*.your-pages-project.pages.dev"
USER_APPROVAL_REQUIRED = "true"
GITHUB_ENABLED = "false"
SESSION_SECRET = "placeholder-set-via-wrangler-secret-put"  # Overridden by secret

# Create with: npx wrangler d1 create inkweld_prod
[[env.production.d1_databases]]
binding = "DB"
database_name = "inkweld_prod"
database_id = "YOUR_PROD_DATABASE_ID_HERE"  # <-- REPLACE THIS
migrations_dir = "drizzle"

# R2 storage for media files (covers, avatars, inline images)
# Create with: npx wrangler r2 bucket create inkweld-storage
[[env.production.r2_buckets]]
binding = "STORAGE"
bucket_name = "inkweld-storage"

[[env.production.durable_objects.bindings]]
name = "YJS_PROJECTS"
class_name = "YjsProject"
script_name = "inkweld-backend-prod"

# ========================================
# SECRETS (set via wrangler secret put)
# ========================================
# Required for each environment:
#   SESSION_SECRET - Session encryption key (32+ characters)
#
# Optional (if features enabled):
#   GITHUB_CLIENT_ID, GITHUB_CLIENT_SECRET
#   RECAPTCHA_SITE_KEY, RECAPTCHA_SECRET_KEY
#
# Set with:
#   npx wrangler secret put SESSION_SECRET --env staging
#   npx wrangler secret put SESSION_SECRET --env production
