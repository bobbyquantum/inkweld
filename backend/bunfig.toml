[test]
# Run setup file before tests to configure environment
preload = ["./test/setup.ts"]

# Enable coverage reporting
coverage = true

# Coverage reporters - lcov is needed for Coverage Gutters
coverageReporter = ["text", "lcov"]

# Coverage directory
coverageDir = "./coverage"

# Exclude specific files/patterns from coverage reports
coveragePathIgnorePatterns = [
  "**/*.test.ts",
  "**/*.spec.ts",
  "**/test/**",
  "**/scripts/**",
  "**/*.config.ts",
  "**/node_modules/**",
  # MCP protocol handlers & tools (require Yjs runtime / Durable Objects)
  "**/mcp/**",
  # Cloudflare Durable Objects (Workers runtime only)
  "**/durable-objects/**",
  # Cloudflare R2 storage adapter (Workers runtime only)
  "**/r2-storage.service.ts",
  # Yjs collaboration services (require LevelDB / Durable Objects)
  "**/yjs.service.ts",
  "**/yjs-worker.service.ts",
  "**/yjs.routes.ts",
  # Image provider implementations (external API clients)
  "**/image-providers/falai-provider.ts",
  "**/image-providers/openai-provider.ts",
  "**/image-providers/openrouter-provider.ts",
  "**/image-providers/stable-diffusion-provider.ts",
  "**/image-providers/workersai-provider.ts",
  "**/image-providers/base-provider.ts",
  # External API clients with no testable logic
  "**/fal-model-metadata.service.ts",
  "**/reference-image-loader.ts",
  # OAuth routes (complex external OAuth 2.1 flows)
  "**/oauth.routes.ts",
  "**/mcp-oauth.service.ts",
  # Image processing & audit (platform-specific / external API dependent)
  "**/image.service.ts",
  "**/image-audit.service.ts",
  "**/image-generation.service.ts",
  # OpenAI lint service (external API calls)
  "**/openai-lint.service.ts",
  # AI text/image route handlers (external AI API dependent)
  "**/ai-text.routes.ts",
  "**/ai-image.routes.ts",
  # MCP route handler (delegates to excluded mcp/ code)
  "**/mcp.routes.ts",
  # Routes dependent on Yjs runtime
  "**/document.routes.ts",
  "**/element.routes.ts",
  # Routes dependent on excluded services (image processing, OpenAI, storage)
  "**/image.routes.ts",
  "**/image-audit.routes.ts",
  "**/lint.routes.ts",
  "**/published-file.routes.ts",
  "**/share.routes.ts",
  # Database schema declarations (declarative table/relation definitions)
  "**/db/schema/*.ts",
  "**/db/bun-sqlite.ts",
  "**/db/index.ts",
  # Static configuration data
  "**/config/default-text-models.ts",
  # Type definition files with provider enums
  "**/types/image-generation.ts",
  # App entry points / runner configuration
  "**/bun-app.ts",
  "**/bun-runner.ts",
  "**/node-runner.ts"
]

# Skip test files when computing coverage statistics
coverageSkipTestFiles = true

# Coverage thresholds (lines: 80%, functions: 80%)
# Matches frontend thresholds: statements=80, branches=60, lines=80, functions=80
# Bun supports line and function thresholds (branch coverage not available)
coverageThreshold = { line = 0.80, function = 0.80 }
