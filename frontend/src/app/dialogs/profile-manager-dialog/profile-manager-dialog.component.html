<div class="profile-manager-dialog">
  <div class="dialog-header">
    <h2>
      @switch (currentView()) {
        @case ('list') {
          <mat-icon>dns</mat-icon>
          Server Profiles
        }
        @case ('add') {
          <mat-icon>add_circle</mat-icon>
          Add Server
        }
        @case ('add-local') {
          <mat-icon>computer</mat-icon>
          Add Local Mode
        }
        @case ('migrate') {
          <mat-icon>cloud_upload</mat-icon>
          @if (isAuthenticated()) {
            @if (localProjectsCount() > 0) {
              Select Projects to Migrate
            } @else {
              Connected to Server
            }
          } @else {
            Log In to Server
          }
        }
      }
    </h2>
    <button mat-icon-button mat-dialog-close class="close-button">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-divider></mat-divider>

  <div class="dialog-content">
    <!-- Profile List View -->
    @if (currentView() === 'list') {
      <div class="profile-list">
        @for (profile of profiles(); track profile.id) {
          @let info = getProfileInfo(profile);
          <button
            type="button"
            class="profile-item"
            [class.active]="info.isActive"
            (click)="switchToProfile(profile)"
            [attr.data-testid]="'profile-item-' + profile.id">
            <div class="profile-icon">
              <mat-icon>{{ info.icon }}</mat-icon>
              @if (info.isActive) {
                <mat-icon class="active-badge">check_circle</mat-icon>
              }
            </div>
            <div class="profile-details">
              <span class="profile-name">{{ info.name }}</span>
              <span class="profile-subtitle">{{ info.subtitle }}</span>
            </div>
            <div class="profile-actions">
              @if (profile.type === 'server' && !hasAuthForProfile(profile)) {
                <mat-icon class="auth-warning" matTooltip="Login required">
                  lock
                </mat-icon>
              }
              @if (!info.isActive) {
                <button
                  mat-icon-button
                  (click)="removeProfile(profile); $event.stopPropagation()"
                  matTooltip="Remove profile"
                  [attr.data-testid]="'remove-profile-' + profile.id">
                  <mat-icon>delete</mat-icon>
                </button>
              }
            </div>
          </button>
        } @empty {
          <div class="empty-state">
            <mat-icon>cloud_off</mat-icon>
            <p>No server profiles configured</p>
          </div>
        }
      </div>

      <mat-divider></mat-divider>

      <div class="list-actions">
        <button
          mat-stroked-button
          (click)="showAddServer()"
          data-testid="add-server-button">
          <mat-icon>add</mat-icon>
          Add Server
        </button>
        @if (!hasLocalProfile()) {
          <button
            mat-stroked-button
            (click)="switchToLocalMode()"
            data-testid="add-local-button">
            <mat-icon>computer</mat-icon>
            Add Local Mode
          </button>
        }
      </div>
    }

    <!-- Add Server View -->
    @if (currentView() === 'add') {
      <div class="add-server-form">
        <p class="form-description">
          Connect to an Inkweld server to sync your projects and collaborate
          with others.
        </p>

        @if (localProjectsCount() > 0) {
          <div class="local-projects-notice">
            <mat-icon>info</mat-icon>
            <span>
              You have {{ localProjectsCount() }} local project(s) that can be
              migrated to the server.
            </span>
          </div>
        }

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Server URL</mat-label>
          <input
            matInput
            [ngModel]="newServerUrl()"
            (ngModelChange)="newServerUrl.set($event)"
            placeholder="https://inkweld.example.com"
            [disabled]="isConnecting()"
            type="url"
            data-testid="new-server-url-input" />
          @if (connectionError()) {
            <mat-error>{{ connectionError() }}</mat-error>
          }
          @if (connectionSuccess()) {
            <mat-hint class="success-hint">
              <mat-icon>check_circle</mat-icon>
              Connection verified
            </mat-hint>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Display Name (optional)</mat-label>
          <input
            matInput
            [ngModel]="newServerName()"
            (ngModelChange)="newServerName.set($event)"
            placeholder="My Inkweld Server"
            [disabled]="isConnecting()"
            type="text"
            data-testid="new-server-name-input" />
          <mat-hint>A friendly name to identify this server</mat-hint>
        </mat-form-field>

        <div class="form-actions">
          <button mat-button (click)="cancelAddServer()">Cancel</button>
          <button
            mat-stroked-button
            (click)="testConnection()"
            [disabled]="isConnecting() || !newServerUrl().trim()">
            @if (isConnecting()) {
              <mat-spinner diameter="18"></mat-spinner>
            } @else {
              <mat-icon>check_circle</mat-icon>
            }
            Test
          </button>
          <button
            mat-raised-button
            color="primary"
            (click)="addServer()"
            [disabled]="isConnecting() || !newServerUrl().trim()"
            data-testid="connect-server-button">
            @if (isConnecting()) {
              <mat-spinner diameter="18"></mat-spinner>
            } @else {
              <mat-icon>cloud</mat-icon>
            }
            Connect
          </button>
        </div>
      </div>
    }

    <!-- Add Local Mode View -->
    @if (currentView() === 'add-local') {
      <div class="add-local-form">
        <p class="form-description">
          Work offline without a server connection. Your data will be stored
          locally on this device.
        </p>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Username</mat-label>
          <input
            matInput
            [ngModel]="localUsername()"
            (ngModelChange)="localUsername.set($event)"
            placeholder="myusername"
            type="text"
            data-testid="local-username-input" />
          @if (localError()) {
            <mat-error>{{ localError() }}</mat-error>
          }
          <mat-hint
            >Used for project URLs (e.g., myusername/my-project)</mat-hint
          >
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Display Name (optional)</mat-label>
          <input
            matInput
            [ngModel]="localDisplayName()"
            (ngModelChange)="localDisplayName.set($event)"
            placeholder="My Name"
            type="text"
            data-testid="local-displayname-input" />
          <mat-hint>Your display name (defaults to username)</mat-hint>
        </mat-form-field>

        <div class="form-actions">
          <button mat-button (click)="cancelAddLocal()">Cancel</button>
          <button
            mat-raised-button
            color="primary"
            (click)="addLocalMode()"
            [disabled]="!localUsername().trim()"
            data-testid="add-local-mode-button">
            <mat-icon>computer</mat-icon>
            Create Local Profile
          </button>
        </div>
      </div>
    }

    <!-- Migration View -->
    @if (currentView() === 'migrate') {
      <div class="migration-form">
        <!-- Step 1: Authentication -->
        @if (!isAuthenticated()) {
          <div class="auth-section">
            <p class="form-description">
              @if (localProjectsCount() > 0) {
                @if (authMode() === 'register') {
                  Create an account on the server to migrate your projects.
                } @else {
                  Log in to your server account to migrate your projects.
                }
              } @else {
                @if (authMode() === 'register') {
                  Create an account to connect to this server.
                } @else {
                  Log in to connect to this server.
                }
              }
            </p>

            @if (authMode() === 'register') {
              <!-- Use shared registration form in external submit mode -->
              <app-registration-form
                #registrationForm
                [compact]="true"
                [externalSubmit]="true"
                [serverUrl]="pendingServerUrl"
                [showSubmitButton]="false"
                testIdPrefix="migration-"
                (submitRequest)="onRegistrationSubmit($event)"
                (validityChange)="onRegistrationValidityChange($event)">
              </app-registration-form>
            } @else {
              <!-- Simple login form -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Username</mat-label>
                <input
                  matInput
                  [ngModel]="username()"
                  (ngModelChange)="username.set($event)"
                  [disabled]="isAuthenticating()"
                  type="text"
                  data-testid="migration-username-input" />
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Password</mat-label>
                <input
                  matInput
                  [ngModel]="password()"
                  (ngModelChange)="password.set($event)"
                  [disabled]="isAuthenticating()"
                  type="password"
                  data-testid="migration-password-input" />
              </mat-form-field>
            }

            @if (authError()) {
              <div class="auth-error">
                <mat-icon>error</mat-icon>
                {{ authError() }}
              </div>
            }

            <div class="auth-actions">
              <button
                mat-button
                (click)="cancelMigration()"
                [disabled]="isAuthenticating()">
                Cancel
              </button>
              <button
                mat-button
                (click)="toggleAuthMode()"
                [disabled]="isAuthenticating()"
                data-testid="toggle-auth-mode-button">
                {{
                  authMode() === 'login'
                    ? 'Need an account? Register'
                    : 'Have an account? Log in'
                }}
              </button>
              @if (authMode() === 'login') {
                <button
                  mat-raised-button
                  color="primary"
                  (click)="authenticate()"
                  [disabled]="isAuthenticating() || !username() || !password()"
                  data-testid="migrate-authenticate-button">
                  @if (isAuthenticating()) {
                    <mat-spinner diameter="18"></mat-spinner>
                    Authenticating...
                  } @else {
                    Log In
                  }
                </button>
              } @else {
                <button
                  mat-raised-button
                  color="primary"
                  (click)="triggerRegistrationSubmit()"
                  [disabled]="isAuthenticating() || !isRegistrationFormValid()"
                  data-testid="migrate-authenticate-button">
                  @if (isAuthenticating()) {
                    <mat-spinner diameter="18"></mat-spinner>
                    Registering...
                  } @else {
                    Register
                  }
                </button>
              }
            </div>
          </div>
        }

        <!-- Step 2a: No projects to migrate - just complete the switch -->
        @if (isAuthenticated() && localProjectsCount() === 0) {
          <div class="no-migration-needed">
            <div class="success-message">
              <mat-icon color="primary">check_circle</mat-icon>
              <div>
                <h4>Connected Successfully!</h4>
                <p>
                  You're now authenticated with the server. Click Continue to
                  switch to your new server profile.
                </p>
              </div>
            </div>

            <div class="migration-actions">
              <button mat-button (click)="cancelMigration()">Cancel</button>
              <button
                mat-raised-button
                color="primary"
                (click)="completeServerSwitch()"
                data-testid="complete-switch-button">
                <mat-icon>arrow_forward</mat-icon>
                Continue
              </button>
            </div>
          </div>
        }

        <!-- Step 2b: Project Selection (after authentication, when there are projects) -->
        @if (
          isAuthenticated() &&
          localProjectsCount() > 0 &&
          !isSyncing() &&
          !syncSuccess() &&
          !syncError()
        ) {
          <div class="project-selection">
            <p class="form-description">
              Select which local projects to migrate to the server.
            </p>

            @if (isCheckingConflicts()) {
              <div class="checking-conflicts">
                <mat-spinner diameter="18"></mat-spinner>
                <span>Checking for existing projects on server...</span>
              </div>
            }

            @if (conflictingSlugs().size > 0) {
              <div class="conflict-warning">
                <mat-icon>warning</mat-icon>
                <span>
                  {{ conflictingSlugs().size }} project(s) already exist on the
                  server. Rename them or deselect to skip.
                </span>
              </div>
            }

            <div class="project-table">
              <div class="project-header">
                <mat-checkbox
                  [checked]="allProjectsSelected()"
                  [indeterminate]="someProjectsSelected()"
                  (change)="toggleAllProjects()"
                  [disabled]="isMigrating()"
                  data-testid="select-all-projects">
                  Select All
                </mat-checkbox>
                <span class="selection-count">
                  {{ selectedProjectSlugs().size }} of
                  {{ localProjectsCount() }} selected
                </span>
              </div>

              <div class="project-list">
                @for (project of localProjects(); track project.slug) {
                  <div
                    class="project-row"
                    [class.selected]="isProjectSelected(project)"
                    [class.has-conflict]="hasSlugConflict(project)">
                    <mat-checkbox
                      [checked]="isProjectSelected(project)"
                      (change)="toggleProjectSelection(project)"
                      [disabled]="isMigrating()"
                      [attr.data-testid]="'select-project-' + project.slug">
                      <div class="project-info">
                        <span class="project-title">{{ project.title }}</span>
                        @if (!hasSlugConflict(project)) {
                          <span class="project-slug"
                            >{{ project.username }}/{{ project.slug }}</span
                          >
                        }
                      </div>
                    </mat-checkbox>
                    @if (hasSlugConflict(project)) {
                      <div class="slug-conflict-row">
                        <mat-icon
                          class="conflict-icon"
                          matTooltip="This slug already exists on the server">
                          warning
                        </mat-icon>
                        <input
                          matInput
                          class="slug-rename-input"
                          [value]="getProjectSlug(project)"
                          (input)="
                            updateProjectSlug(
                              project,
                              $any($event.target).value
                            )
                          "
                          placeholder="Enter new slug"
                          [attr.data-testid]="'rename-slug-' + project.slug" />
                        @if (projectRenames().get(project.slug); as newSlug) {
                          @if (wouldSlugConflict(newSlug)) {
                            <mat-icon
                              class="conflict-icon"
                              matTooltip="This slug also conflicts">
                              error
                            </mat-icon>
                          } @else if (isValidSlug(newSlug)) {
                            <mat-icon class="valid-icon">
                              check_circle
                            </mat-icon>
                          }
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            </div>

            @if (authError()) {
              <div class="auth-error">
                <mat-icon>error</mat-icon>
                {{ authError() }}
              </div>
            }

            <div class="migration-actions">
              <button
                mat-button
                (click)="cancelMigration()"
                [disabled]="isMigrating()">
                Cancel
              </button>
              <button
                mat-raised-button
                color="primary"
                (click)="migrateProjects()"
                [disabled]="isMigrating() || hasUnresolvedConflicts()"
                data-testid="migrate-projects-button">
                @if (isMigrating()) {
                  <mat-spinner diameter="18"></mat-spinner>
                  Migrating...
                } @else if (selectedProjectSlugs().size > 0) {
                  Migrate ({{ selectedProjectSlugs().size }})
                } @else {
                  Skip Migration
                }
              </button>
            </div>
          </div>
        }

        <!-- Migration Progress -->
        @if (
          migrationState().status === MigrationStatus.InProgress && !isSyncing()
        ) {
          <div class="migration-progress">
            <h4>
              <mat-icon class="spinning">sync</mat-icon>
              Migrating Projects...
            </h4>

            <mat-progress-bar mode="determinate" [value]="migrationProgress()">
            </mat-progress-bar>

            <p class="progress-text">
              {{ migrationState().completedProjects }} of
              {{ migrationState().totalProjects }} projects migrated
            </p>

            @if (migrationState().currentProject) {
              <p class="current-project">
                Currently migrating:
                <strong>{{ migrationState().currentProject }}</strong>
              </p>
            }

            <div class="project-statuses">
              @for (
                projectStatus of migrationState().projectStatuses;
                track projectStatus.projectSlug
              ) {
                <div
                  class="project-status"
                  [class]="projectStatus.status.toLowerCase()">
                  @switch (projectStatus.status) {
                    @case (MigrationStatus.Completed) {
                      <mat-icon class="status-icon">check_circle</mat-icon>
                    }
                    @case (MigrationStatus.InProgress) {
                      <mat-spinner
                        diameter="16"
                        class="status-icon"></mat-spinner>
                    }
                    @case (MigrationStatus.Failed) {
                      <mat-icon class="status-icon">error</mat-icon>
                    }
                    @default {
                      <mat-icon class="status-icon">pending</mat-icon>
                    }
                  }
                  <span class="project-title">{{
                    projectStatus.projectTitle
                  }}</span>
                  @if (projectStatus.error) {
                    <span class="error-message">{{ projectStatus.error }}</span>
                  }
                </div>
              }
            </div>
          </div>
        }

        <!-- Syncing to Server -->
        @if (isSyncing()) {
          <div class="migration-progress" data-testid="sync-progress">
            <h4>
              <mat-icon class="spinning">cloud_upload</mat-icon>
              Syncing to Server...
            </h4>

            <mat-progress-bar mode="indeterminate"></mat-progress-bar>

            <p class="progress-text">Creating projects on the server...</p>
          </div>
        }

        <!-- Sync Complete / Migration Complete -->
        @if (syncSuccess()) {
          <div class="migration-complete" data-testid="sync-success">
            <mat-icon class="success-icon">check_circle</mat-icon>
            <h4>Migration Complete!</h4>
            <p>
              Successfully migrated
              {{ migrationState().completedProjects }} project(s) to the server.
            </p>
            <p class="redirect-notice">Redirecting to home...</p>
          </div>
        }

        <!-- Sync Error (partial success) -->
        @if (syncError()) {
          <div class="migration-failed" data-testid="sync-error">
            <mat-icon class="warning-icon">warning</mat-icon>
            <h4>Sync Partially Complete</h4>
            <p>{{ syncError() }}</p>
            <button mat-button (click)="cancelMigration()">Close</button>
          </div>
        }

        <!-- Migration Failed -->
        @if (
          migrationState().status === MigrationStatus.Failed &&
          !isSyncing() &&
          !syncSuccess()
        ) {
          <div class="migration-failed">
            <mat-icon class="error-icon">error</mat-icon>
            <h4>Migration Completed with Errors</h4>
            <p>
              {{ migrationState().completedProjects }} project(s) succeeded,
              {{ migrationState().failedProjects }} failed.
            </p>
            <button mat-button (click)="cancelMigration()">Close</button>
          </div>
        }
      </div>
    }
  </div>
</div>
