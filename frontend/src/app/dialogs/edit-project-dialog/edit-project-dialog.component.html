<mat-dialog-content class="dialog-content">
  <!-- Image Cropper View -->
  @if (showCropper) {
    <div class="cropper-view">
      <h3 class="cropper-title">Crop Cover Image</h3>
      <p class="cropper-subtitle">
        Adjust the selection to fit your project cover (1:1.6 ratio, recommended
        1600Ã—2560px)
      </p>
      <div class="cropper-container">
        <image-cropper
          [imageChangedEvent]="imageChangedEvent"
          [imageBase64]="imageBase64"
          [maintainAspectRatio]="true"
          [aspectRatio]="coverAspectRatio"
          [roundCropper]="false"
          format="png"
          output="blob"
          [resizeToWidth]="1600"
          [resizeToHeight]="2560"
          [cropperMinWidth]="400"
          [cropperMinHeight]="640"
          [onlyScaleDown]="true"
          (imageCropped)="imageCropped($event)"
          (imageLoaded)="onImageLoaded($event)"
          (cropperReady)="onCropperReady()"
          (loadImageFailed)="onLoadImageFailed()">
        </image-cropper>
      </div>
    </div>
  } @else {
    <!-- Normal Dialog View -->
    <div class="dialog-layout">
      <!-- Left column: Cover image -->
      <div class="cover-column">
        @if (coverImageUrl && !isLoadingCover) {
          <div class="cover-image-wrapper">
            <img
              [src]="coverImageUrl"
              alt="Project cover image"
              class="cover-preview" />
            <button
              mat-mini-fab
              color="warn"
              class="remove-image-btn"
              (click)="removeCoverImage()"
              [disabled]="isLoadingCover"
              aria-label="Remove cover image">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        } @else if (isLoadingCover) {
          <div class="placeholder-wrapper">
            <mat-progress-bar
              mode="indeterminate"
              class="loading-bar"></mat-progress-bar>
          </div>
        } @else {
          <div class="placeholder-wrapper">
            <mat-icon class="placeholder-icon">image</mat-icon>
            <p class="placeholder-text">No cover image</p>
            <p class="placeholder-text">1:1.6 ratio</p>
          </div>
        }
      </div>

      <!-- Right column: Form -->
      <div class="form-column">
        <form [formGroup]="form">
          <mat-form-field appearance="outline">
            <mat-label>Title</mat-label>
            <input matInput formControlName="title" required />
            @if (form.get('title')?.hasError('required')) {
              <mat-error>Title is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Description</mat-label>
            <textarea
              matInput
              formControlName="description"
              rows="4"></textarea>
          </mat-form-field>

          <div class="cover-image-controls">
            <h3>Cover Image</h3>
            <div class="cover-buttons">
              <button
                mat-stroked-button
                color="primary"
                (click)="openCoverImageSelector()"
                [disabled]="isLoadingCover">
                <mat-icon>add_photo_alternate</mat-icon>
                Upload Image
              </button>
              <button
                mat-stroked-button
                color="primary"
                (click)="openMediaLibrarySelector()"
                [disabled]="isLoadingCover">
                <mat-icon>photo_library</mat-icon>
                Select from Library
              </button>
              <button
                mat-stroked-button
                color="primary"
                (click)="openGenerateCoverDialog()"
                [disabled]="isLoadingCover">
                <mat-icon>auto_awesome</mat-icon>
                Generate with AI
              </button>
            </div>
          </div>
        </form>

        <!-- Hidden file input for cover image selection -->
        <input
          #coverImageInput
          type="file"
          accept="image/jpeg,image/jpg,image/png"
          style="display: none"
          (change)="onCoverImageSelected($event)" />
      </div>
    </div>
  }
</mat-dialog-content>

<mat-dialog-actions align="end">
  @if (showCropper) {
    <button mat-button (click)="cancelCropping()">Cancel</button>
    <button
      mat-raised-button
      color="primary"
      (click)="applyCroppedImage()"
      [disabled]="!croppedBlob">
      Apply
    </button>
  } @else {
    <button mat-button mat-dialog-close>Cancel</button>
    <button
      mat-raised-button
      color="primary"
      [disabled]="form.invalid || isSaving"
      (click)="onSave()">
      Save
    </button>
  }
</mat-dialog-actions>
