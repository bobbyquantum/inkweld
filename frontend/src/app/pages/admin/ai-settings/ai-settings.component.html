<div class="ai-settings-container">
  <!-- AI Kill Switch Warning Banner -->
  @if (isAiKillSwitchEnabled()) {
    <mat-card class="kill-switch-warning">
      <mat-card-header>
        <mat-icon mat-card-avatar class="warning-icon">block</mat-icon>
        <mat-card-title>AI Features Disabled</mat-card-title>
        <mat-card-subtitle>
          @if (isAiKillSwitchLockedByEnv()) {
            AI features are disabled by the
            <code>AI_KILL_SWITCH</code> environment variable.
          } @else {
            The AI Kill Switch is enabled. All AI features are currently
            disabled.
          }
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <p>
          While the kill switch is enabled, AI image generation and AI linting
          features will not be available to users. You can still configure AI
          providers below, but they will not be used until the kill switch is
          disabled.
        </p>
      </mat-card-content>
      @if (!isAiKillSwitchLockedByEnv()) {
        <mat-card-actions>
          <a mat-button color="primary" routerLink="/admin/settings">
            <mat-icon>settings</mat-icon>
            Go to Settings to disable Kill Switch
          </a>
        </mat-card-actions>
      }
    </mat-card>
  }

  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading AI configuration...</p>
    </div>
  } @else if (error()) {
    <mat-card class="error-card">
      <mat-card-header>
        <mat-icon mat-card-avatar>error</mat-icon>
        <mat-card-title>Error Loading Configuration</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <p>{{ error()?.message }}</p>
      </mat-card-content>
      <mat-card-actions>
        <button mat-button color="primary" (click)="loadConfig()">
          <mat-icon>refresh</mat-icon>
          Retry
        </button>
      </mat-card-actions>
    </mat-card>
  } @else {
    <!-- Global Enable Toggle -->
    <mat-card class="settings-card">
      <mat-card-header>
        <mat-icon mat-card-avatar>auto_awesome</mat-icon>
        <mat-card-title>AI Image Generation</mat-card-title>
        <mat-card-subtitle>
          Enable or disable AI-powered image generation
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="setting-row">
          <div class="setting-info">
            <span class="setting-label">Enable Image Generation</span>
            <span class="setting-description">
              Allow users to generate images using AI providers
            </span>
          </div>
          <mat-slide-toggle
            [checked]="imageGenerationEnabled()"
            (change)="saveGlobalEnabled($event.checked)"
            [disabled]="isSaving()">
          </mat-slide-toggle>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Model List -->
    @if (imageGenerationEnabled()) {
      @if (unifiedModels().length > 0) {
        <!-- Default Model Display -->
        @if (defaultModelInfo(); as defaultModel) {
          <mat-card class="settings-card default-model-card">
            <mat-card-header>
              <mat-icon mat-card-avatar>auto_awesome</mat-icon>
              <mat-card-title>Default Model</mat-card-title>
              <mat-card-subtitle>
                {{ defaultModel.providerName }}
              </mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="default-model-display">
                <span class="default-model-name">{{ defaultModel.name }}</span>
                @if (defaultModel.description) {
                  <span class="default-model-description">{{
                    defaultModel.description
                  }}</span>
                }
              </div>
            </mat-card-content>
          </mat-card>
        }

        <!-- Models by Provider -->
        @for (group of modelsByProvider(); track group.providerId) {
          <mat-card class="settings-card provider-models-card">
            <mat-card-header>
              <mat-icon mat-card-avatar>api</mat-icon>
              <mat-card-title>{{ group.providerName }}</mat-card-title>
              <mat-card-subtitle>
                {{ group.models.length }}
                {{ group.models.length === 1 ? 'model' : 'models' }}
              </mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="model-list">
                @for (model of group.models; track model.id) {
                  <div class="model-item">
                    <mat-slide-toggle
                      class="model-toggle"
                      [checked]="model.enabled"
                      (change)="toggleUnifiedModel(model.id, $event.checked)"
                      [disabled]="isSaving()">
                    </mat-slide-toggle>
                    <div class="model-info">
                      <span class="model-name">
                        {{ model.name }}
                        @if (model.isDefault) {
                          <mat-chip class="default-chip">Default</mat-chip>
                        }
                      </span>
                      @if (model.description) {
                        <span class="model-description">{{
                          model.description
                        }}</span>
                      }
                    </div>
                    <div class="model-actions">
                      @if (!model.isDefault && model.enabled) {
                        <button
                          mat-stroked-button
                          (click)="setAsDefaultModel(model.id)"
                          [disabled]="isSaving()">
                          Make Default
                        </button>
                      }
                    </div>
                  </div>
                }
              </div>
            </mat-card-content>
          </mat-card>
        }

        @if (unifiedModelsModified()) {
          <div class="save-actions">
            <button
              mat-raised-button
              color="primary"
              (click)="saveUnifiedModels()"
              [disabled]="isSaving()">
              <mat-icon>save</mat-icon>
              Save Changes
            </button>
          </div>
        }
      } @else {
        <mat-card class="settings-card empty-state-card">
          <mat-card-header>
            <mat-icon mat-card-avatar>view_list</mat-icon>
            <mat-card-title>Available Models</mat-card-title>
            <mat-card-subtitle>No models available</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="empty-state">
              <mat-icon>api</mat-icon>
              <p>
                Configure at least one AI provider with an API key on the
                <a routerLink="/admin/ai">AI Providers</a> page to see available
                models.
              </p>
            </div>
          </mat-card-content>
        </mat-card>
      }

      <!-- Custom Image Sizes -->
      <mat-card class="settings-card">
        <mat-card-header>
          <mat-icon mat-card-avatar>photo_size_select_large</mat-icon>
          <mat-card-title>Custom Image Sizes</mat-card-title>
          <mat-card-subtitle>
            Define custom resolution profiles for image generation
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <p class="help-text">
            Custom sizes are available in addition to the standard sizes offered
            by each provider. Note that not all providers support all sizes.
          </p>

          <!-- Existing Custom Sizes -->
          @if (customSizes().length > 0) {
            <div class="custom-sizes-list">
              @for (size of customSizes(); track size.id) {
                <div class="custom-size-item">
                  <div class="size-info">
                    <span class="size-name">{{ size.name }}</span>
                    <span class="size-dimensions">
                      {{ getSizeString(size) }} ({{
                        getAspectRatioLabel(size)
                      }})
                    </span>
                    @if (size.description) {
                      <span class="size-description">{{
                        size.description
                      }}</span>
                    }
                  </div>
                  <button
                    mat-icon-button
                    color="warn"
                    (click)="removeCustomSize(size.id)"
                    matTooltip="Remove this size">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              }
            </div>
          } @else {
            <div class="empty-state small">
              <mat-icon>crop_free</mat-icon>
              <p>No custom sizes defined</p>
            </div>
          }

          <mat-divider></mat-divider>

          <!-- Add New Size Form -->
          @if (editingNewSize()) {
            <div class="add-size-form">
              <h4>Add Custom Size</h4>
              <div class="size-form-row">
                <mat-form-field appearance="outline">
                  <mat-label>Name</mat-label>
                  <input
                    matInput
                    [value]="newSize().name"
                    (input)="updateNewSizeName($any($event.target).value)"
                    placeholder="e.g., HD Landscape" />
                </mat-form-field>
              </div>
              <div class="size-form-row dimensions-row">
                <mat-form-field appearance="outline">
                  <mat-label>Width (px)</mat-label>
                  <input
                    matInput
                    type="number"
                    min="256"
                    max="4096"
                    [value]="newSize().width"
                    (input)="updateNewSizeWidth(+$any($event.target).value)" />
                </mat-form-field>
                <span class="dimension-separator">Ã—</span>
                <mat-form-field appearance="outline">
                  <mat-label>Height (px)</mat-label>
                  <input
                    matInput
                    type="number"
                    min="256"
                    max="4096"
                    [value]="newSize().height"
                    (input)="updateNewSizeHeight(+$any($event.target).value)" />
                </mat-form-field>
              </div>
              <div class="size-form-row">
                <mat-form-field appearance="outline">
                  <mat-label>Description (optional)</mat-label>
                  <input
                    matInput
                    [value]="newSize().description || ''"
                    (input)="
                      updateNewSizeDescription($any($event.target).value)
                    "
                    placeholder="e.g., Standard HD for wallpapers" />
                </mat-form-field>
              </div>
              <div class="size-form-actions">
                <button mat-button (click)="cancelAddingSize()">Cancel</button>
                <button
                  mat-raised-button
                  color="primary"
                  (click)="addCustomSize()"
                  [disabled]="
                    !newSize().name || !newSize().width || !newSize().height
                  ">
                  Add Size
                </button>
              </div>
            </div>
          } @else {
            <button
              mat-stroked-button
              color="primary"
              (click)="startAddingSize()"
              class="add-size-button">
              <mat-icon>add</mat-icon>
              Add Custom Size
            </button>
          }
        </mat-card-content>

        @if (customSizesModified()) {
          <mat-card-actions align="end">
            <button mat-button color="warn" (click)="resetCustomSizes()">
              <mat-icon>clear_all</mat-icon>
              Clear All
            </button>
            <button
              mat-raised-button
              color="primary"
              (click)="saveCustomSizes()"
              [disabled]="isSaving()">
              <mat-icon>save</mat-icon>
              Save Custom Sizes
            </button>
          </mat-card-actions>
        }
      </mat-card>
    }
  }
</div>
