@if (projectState.isLoading()) {
  <div class="loading-indicator">
    <mat-spinner diameter="40"></mat-spinner>
  </div>
}

<!-- Zen mode overlay -->
@if (isZenMode()) {
  <div class="zen-mode-overlay">
    <div class="zen-mode-editor-container">
      <button
        mat-icon-button
        class="zen-mode-close-button"
        (click)="toggleZenMode()">
        <mat-icon>close</mat-icon>
      </button>
      @if (getCurrentDocumentId()) {
        @defer (on idle) {
          <app-document-element-editor
            [documentId]="getCurrentDocumentId()!"
            [tabsDisabled]="!useTabsDesktop()"
            [zenMode]="true">
          </app-document-element-editor>
        } @placeholder {
          <div class="zen-editor-placeholder">
            <mat-spinner diameter="40"></mat-spinner>
          </div>
        }
      }
    </div>
  </div>
}

<mat-sidenav-container class="main-container">
  <!-- Mobile sidenav -->
  @if (isMobile()) {
    <mat-sidenav
      mode="over"
      [opened]="false"
      class="sidenav-content mobile-sidenav">
      <div class="mobile-sidenav-content">
        <div class="mobile-open-tabs">
          <div class="mobile-tabs-list">
            <div
              class="mobile-tab-item"
              (click)="goHome()"
              tabindex="0"
              role="button"
              (keydown.enter)="goHome()"
              (keydown.space)="goHome()"
              [class.active]="projectState.selectedTabIndex() === 0">
              <mat-icon>home</mat-icon>
              <span class="mobile-tab-name">Home</span>
            </div>
          </div>
        </div>
        @defer (on idle) {
          <app-project-tree
            (documentOpened)="onDocumentOpened($event)"></app-project-tree>
        } @placeholder {
          <div class="tree-placeholder">
            <mat-spinner diameter="30"></mat-spinner>
          </div>
        }
        <!-- Connection Status -->
        @defer (on idle) {
          <app-connection-status
            [syncState]="projectSyncState()"
            [lastError]="lastConnectionError()"
            [isLocalMode]="isLocalMode()"
            (syncRequested)="onRetrySyncConnection()"
            data-testid="mobile-connection-status">
          </app-connection-status>
        } @placeholder {
          <div class="connection-placeholder"></div>
        }
        <!-- Fixed bottom navigation -->
        <div class="mobile-sidenav-bottom-nav">
          <div
            class="mobile-nav-item"
            [class.selected-item]="isSystemTabSelected('media')"
            data-testid="mobile-media-button"
            tabindex="0"
            role="button"
            (click)="onShowMediaLibrary(); toggleSidebar()"
            (keyup.enter)="onShowMediaLibrary(); toggleSidebar()"
            aria-label="Media Library">
            <mat-icon>perm_media</mat-icon>
            <span class="nav-title">Media Library</span>
          </div>
          <div
            class="mobile-nav-item"
            [class.selected-item]="isSystemTabSelected('settings')"
            data-testid="mobile-settings-button"
            tabindex="0"
            role="button"
            (click)="onShowSettings(); toggleSidebar()"
            (keyup.enter)="onShowSettings(); toggleSidebar()"
            aria-label="Project Settings">
            <mat-icon>settings</mat-icon>
            <span class="nav-title">Project Settings</span>
          </div>
          <div
            class="mobile-nav-item exit-item"
            data-testid="mobile-exit-button"
            tabindex="0"
            role="button"
            (click)="exitProject()"
            (keyup.enter)="exitProject()"
            aria-label="Exit Project">
            <mat-icon>exit_to_app</mat-icon>
            <span class="nav-title">Exit Project</span>
          </div>
        </div>
      </div>
    </mat-sidenav>
  }
  <mat-sidenav-content [class.no-toolbar]="!isMobile() && useTabsDesktop()">
    <!-- Main toolbar - only shown on mobile or when desktop tabs are disabled -->
    @if (isMobile() || !useTabsDesktop()) {
      <mat-toolbar class="mobile-toolbar">
        <button mat-icon-button (click)="toggleSidebar()">
          <mat-icon>menu</mat-icon>
        </button>
        <span class="project-title">{{ projectState.project()?.title }}</span>
        <span class="toolbar-spacer"></span>
        <div class="toolbar-actions">
          <button
            mat-icon-button
            [matMenuTriggerFor]="moreMenuMobile"
            class="action-button"
            data-testid="project-more-menu-button">
            <mat-icon>more_vert</mat-icon>
          </button>
          <app-user-menu
            [miniMode]="true"
            class="action-button"></app-user-menu>
        </div>
        <mat-menu #moreMenuMobile="matMenu">
          @if (canEnableZenMode() || isZenMode()) {
            <button mat-menu-item (click)="toggleZenMode()">
              <mat-icon>self_improvement</mat-icon>
              <span>Toggle Zen Mode</span>
            </button>
          }
          <button
            mat-menu-item
            (click)="onExportClicked()"
            data-testid="export-project-button">
            <mat-icon>download</mat-icon>
            <span>Export project</span>
          </button>
          <button
            mat-menu-item
            (click)="onImportClicked()"
            data-testid="import-project-button">
            <mat-icon>upload</mat-icon>
            <span>Import project</span>
          </button>
          <button
            mat-menu-item
            (click)="onDeleteProjectClick()"
            data-testid="delete-project-button">
            <mat-icon>delete</mat-icon>
            <span>Delete project</span>
          </button>
          <button mat-menu-item (click)="onPublishClick()">
            <mat-icon>publish</mat-icon>
            <span>Publish project</span>
          </button>
          <button mat-menu-item (click)="onShowDocumentList()">
            <mat-icon>list</mat-icon>
            <span>Show Document List</span>
          </button>
        </mat-menu>
      </mat-toolbar>
    }

    <!-- Desktop menu (used when projected into tab bar - defined outside @if to be accessible) -->
    <mat-menu #moreMenuDesktop="matMenu">
      @if (canEnableZenMode() || isZenMode()) {
        <button mat-menu-item (click)="toggleZenMode()">
          <mat-icon>self_improvement</mat-icon>
          <span>Toggle Zen Mode</span>
        </button>
      }
      <button
        mat-menu-item
        (click)="onExportClicked()"
        data-testid="export-project-button">
        <mat-icon>download</mat-icon>
        <span>Export project</span>
      </button>
      <button
        mat-menu-item
        (click)="onImportClicked()"
        data-testid="import-project-button">
        <mat-icon>upload</mat-icon>
        <span>Import project</span>
      </button>
      <button
        mat-menu-item
        (click)="onDeleteProjectClick()"
        data-testid="delete-project-button">
        <mat-icon>delete</mat-icon>
        <span>Delete project</span>
      </button>
      <button mat-menu-item (click)="onPublishClick()">
        <mat-icon>publish</mat-icon>
        <span>Publish project</span>
      </button>
      <button mat-menu-item (click)="onShowDocumentList()">
        <mat-icon>list</mat-icon>
        <span>Show Document List</span>
      </button>
    </mat-menu>

    @if (isMobile()) {
      <div class="mobile-content-wrapper">
        <!-- Content area only (tabs removed since we now use sidenav navigation) -->
        <div class="content-area">
          <router-outlet></router-outlet>
        </div>
      </div>
    } @else {
      @if (showSidebar()) {
        @if (sidebarCollapsed()) {
          <!-- Desktop collapsed sidebar -->
          <div class="collapsed-sidebar-container">
            <div class="collapsed-sidebar">
              <!-- Top section: Expand toggle, Home, New Document -->
              <div class="collapsed-sidebar-top">
                <button
                  mat-icon-button
                  (click)="toggleSidebarCollapsed()"
                  matTooltip="Expand Sidebar"
                  data-testid="sidebar-expand-button"
                  aria-label="Expand Sidebar">
                  <mat-icon fontSet="material-symbols-outlined"
                    >left_panel_open</mat-icon
                  >
                </button>
                <button
                  mat-icon-button
                  (click)="goHome()"
                  [class.active]="projectState.selectedTabIndex() === 0"
                  matTooltip="Home"
                  data-testid="collapsed-home-button"
                  aria-label="Home">
                  <mat-icon>home</mat-icon>
                </button>
                <button
                  mat-icon-button
                  (click)="openQuickOpen()"
                  matTooltip="Quick Open (Ctrl+P)"
                  data-testid="collapsed-quick-open-button"
                  aria-label="Quick Open">
                  <mat-icon>search</mat-icon>
                </button>
                @if (projectState.canWrite()) {
                  <button
                    mat-icon-button
                    (click)="onCreateNewDocument()"
                    matTooltip="New Document"
                    data-testid="collapsed-new-document-button"
                    aria-label="New Document">
                    <mat-icon>note_add</mat-icon>
                  </button>
                }
              </div>

              <!-- Bottom section: Sync, Media, Settings, Exit -->
              <div class="collapsed-sidebar-bottom">
                @defer (on idle) {
                  <app-connection-status
                    [syncState]="projectSyncState()"
                    [lastError]="lastConnectionError()"
                    [isLocalMode]="isLocalMode()"
                    [collapsed]="true"
                    (syncRequested)="onRetrySyncConnection()"
                    data-testid="collapsed-connection-status">
                  </app-connection-status>
                } @placeholder {
                  <div class="collapsed-connection-placeholder"></div>
                }
                <button
                  mat-icon-button
                  (click)="onShowMediaLibrary()"
                  [class.active]="isSystemTabSelected('media')"
                  matTooltip="Media Library"
                  data-testid="collapsed-media-button"
                  aria-label="Media Library">
                  <mat-icon>perm_media</mat-icon>
                </button>
                <button
                  mat-icon-button
                  (click)="onShowSettings()"
                  [class.active]="isSystemTabSelected('settings')"
                  matTooltip="Project Settings"
                  data-testid="collapsed-settings-button"
                  aria-label="Project Settings">
                  <mat-icon>settings</mat-icon>
                </button>
                <button
                  mat-icon-button
                  (click)="exitProject()"
                  matTooltip="Exit Project"
                  data-testid="collapsed-exit-button"
                  aria-label="Exit Project">
                  <mat-icon>exit_to_app</mat-icon>
                </button>
              </div>
            </div>

            <!-- Full-width content area next to collapsed sidebar -->
            <div class="desktop-content collapsed-content">
              @if (useTabsDesktop()) {
                <div class="tabs-header">
                  <app-tab-interface (importRequested)="onImportClicked()">
                    <!-- Projected into tab-bar-actions -->
                    <app-presence-indicator></app-presence-indicator>
                    <button
                      mat-icon-button
                      [matMenuTriggerFor]="moreMenuDesktop"
                      class="action-button"
                      data-testid="project-more-menu-button"
                      aria-label="More actions">
                      <mat-icon>more_vert</mat-icon>
                    </button>
                    <app-user-menu
                      [miniMode]="true"
                      class="action-button"></app-user-menu>
                  </app-tab-interface>
                </div>
              }
              <div class="content-area">
                <router-outlet></router-outlet>
              </div>
            </div>
          </div>
        } @else {
          <!-- Desktop split layout -->
          <as-split
            direction="horizontal"
            [gutterSize]="getGutterSize()"
            unit="percent"
            [useTransition]="true"
            (dragEnd)="onSplitDragEnd($event)">
            <!-- Custom gutter template -->
            <div
              *asSplitGutter="let isDragged = isDragged"
              class="inkweld-gutter"
              [class.dragging]="isDragged">
              <div class="inkweld-gutter-icon"></div>
            </div>
            <!-- Sidebar area -->
            <as-split-area [size]="splitSize" [minSize]="15" [maxSize]="40">
              <div class="sidebar-area">
                @defer (on idle) {
                  <app-project-tree
                    [showCollapseButton]="true"
                    (collapseRequested)="toggleSidebarCollapsed()"
                    (documentOpened)="
                      onDocumentOpened($event)
                    "></app-project-tree>
                } @placeholder {
                  <div class="tree-placeholder">
                    <mat-spinner diameter="30"></mat-spinner>
                  </div>
                }
                <!-- Connection Status -->
                @defer (on idle) {
                  <app-connection-status
                    [syncState]="projectSyncState()"
                    [lastError]="lastConnectionError()"
                    [isLocalMode]="isLocalMode()"
                    (syncRequested)="onRetrySyncConnection()"
                    data-testid="sidebar-connection-status">
                  </app-connection-status>
                } @placeholder {
                  <div class="connection-placeholder"></div>
                }
                <!-- Fixed bottom navigation -->
                <div class="sidebar-bottom-nav">
                  <div
                    class="sidebar-nav-item"
                    [class.selected-item]="isSystemTabSelected('media')"
                    data-testid="sidebar-media-button"
                    tabindex="0"
                    role="button"
                    (click)="onShowMediaLibrary()"
                    (keyup.enter)="onShowMediaLibrary()"
                    aria-label="Media Library">
                    <mat-icon>perm_media</mat-icon>
                    <span class="nav-title">Media Library</span>
                  </div>
                  <div
                    class="sidebar-nav-item"
                    [class.selected-item]="isSystemTabSelected('settings')"
                    data-testid="sidebar-settings-button"
                    tabindex="0"
                    role="button"
                    (click)="onShowSettings()"
                    (keyup.enter)="onShowSettings()"
                    aria-label="Project Settings">
                    <mat-icon>settings</mat-icon>
                    <span class="nav-title">Project Settings</span>
                  </div>
                  <div
                    class="sidebar-nav-item exit-item"
                    data-testid="sidebar-exit-button"
                    tabindex="0"
                    role="button"
                    (click)="exitProject()"
                    (keyup.enter)="exitProject()"
                    aria-label="Exit Project">
                    <mat-icon>exit_to_app</mat-icon>
                    <span class="nav-title">Exit Project</span>
                  </div>
                </div>
              </div>
            </as-split-area>
            <!-- Content area -->
            <as-split-area>
              <div class="desktop-content">
                @if (useTabsDesktop()) {
                  <div class="tabs-header">
                    <app-tab-interface (importRequested)="onImportClicked()">
                      <!-- Projected into tab-bar-actions -->
                      <app-presence-indicator></app-presence-indicator>
                      <button
                        mat-icon-button
                        [matMenuTriggerFor]="moreMenuDesktop"
                        class="action-button"
                        data-testid="project-more-menu-button"
                        aria-label="More actions">
                        <mat-icon>more_vert</mat-icon>
                      </button>
                      <app-user-menu
                        [miniMode]="true"
                        class="action-button"></app-user-menu>
                    </app-tab-interface>
                  </div>
                }
                <div class="content-area">
                  <router-outlet></router-outlet>
                </div>
              </div>
            </as-split-area>
          </as-split>
        }
      } @else {
        <!-- Desktop full-width content -->
        <div class="desktop-content">
          @if (useTabsDesktop()) {
            <div class="tabs-header">
              <app-tab-interface (importRequested)="onImportClicked()">
                <!-- Projected into tab-bar-actions -->
                <app-presence-indicator></app-presence-indicator>
                <button
                  mat-icon-button
                  [matMenuTriggerFor]="moreMenuDesktop"
                  class="action-button"
                  data-testid="project-more-menu-button"
                  aria-label="More actions">
                  <mat-icon>more_vert</mat-icon>
                </button>
                <app-user-menu
                  [miniMode]="true"
                  class="action-button"></app-user-menu>
              </app-tab-interface>
            </div>
          }
          <div class="content-area">
            <router-outlet></router-outlet>
          </div>
        </div>
      }
    }
  </mat-sidenav-content>
</mat-sidenav-container>
