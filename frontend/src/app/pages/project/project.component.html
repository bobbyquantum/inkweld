@if (projectState.isLoading()) {
  <div class="loading-indicator">
    <mat-spinner diameter="40"></mat-spinner>
  </div>
}

<mat-sidenav-container class="main-container">
  <mat-sidenav
    [mode]="isMobile() ? 'over' : 'side'"
    [opened]="!isMobile()"
    class="sidenav-content">
    @if (!isMobile()) {
      <mat-toolbar class="project-toolbar">
        <button mat-icon-button (click)="exitProject()">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <span class="project-title">{{ projectState.project()?.title }}</span>
        <button mat-icon-button (click)="projectState.showNewElementDialog()">
          <mat-icon>add</mat-icon>
        </button>
      </mat-toolbar>
    }
    <app-project-tree></app-project-tree>
    @if (isMobile()) {
      <div class="mobile-exit-button">
        <button mat-raised-button color="warn" (click)="exitProject()">
          Exit Project
        </button>
      </div>
    }

    @if (!isMobile()) {
      <app-user-menu [miniMode]="false"></app-user-menu>
      <div
        cdkDrag
        cdkDragLockAxis="x"
        [cdkDragBoundary]="'.main-container'"
        (cdkDragStarted)="onDragStart()"
        (cdkDragEnded)="onDragEnd($event)"
        class="resize-handle"></div>
    }
  </mat-sidenav>
  <mat-sidenav-content>
    @if (isMobile()) {
      <mat-toolbar class="mobile-toolbar">
        <button mat-icon-button (click)="toggleSidenav()">
          <mat-icon>menu</mat-icon>
        </button>
        <span class="project-title">{{ projectState.project()?.title }}</span>
        <!-- Space for additional mobile actions -->
        <span class="toolbar-spacer"></span>
        <!-- Add more mobile-specific actions here -->
        <app-user-menu [miniMode]="true"></app-user-menu>
      </mat-toolbar>
    }

    <mat-tab-group
      [selectedIndex]="projectState.selectedTabIndex()"
      class="tab-bars"
      mat-stretch-tabs="false"
      mat-align-tabs="start">
      <mat-tab>
        <ng-template mat-tab-label>
          <div class="tab-label home-tab">
            <mat-icon>home</mat-icon>
          </div>
        </ng-template>
        <div class="home-tab-content">
          <div class="full-width-column">
            <div class="full-width-header">
              <h2>{{ projectState.project()?.title }}</h2>
              <p>
                {{ projectState.project()?.description }}
              </p>
            </div>
          </div>

          <div class="columns-container">
            <div class="home-column">
              <div class="home-column-header">
                <h3>Start</h3>
              </div>

              <div class="start-actions">
                <button mat-button color="primary">New File</button>
                <button mat-button color="primary">Import File</button>
              </div>
            </div>
            <div class="home-column">
              <div class="home-column-header">
                <h3>Recent Files</h3>
              </div>
              <p>Dummy recent files list.</p>
            </div>
          </div>
        </div>
      </mat-tab>
      @for (file of projectState.openFiles(); track file.id; let i = $index) {
        <mat-tab>
          <ng-template mat-tab-label>
            <div class="tab-label">
              {{ file.name }}
              @switch (documentService.getSyncStatus(file.id) | async) {
                @case (DocumentSyncState.Unavailable) {
                  <div
                    class="connection-status unavailable"
                    title="Document not found locally"></div>
                }
                @case (DocumentSyncState.Offline) {
                  <div
                    class="connection-status offline"
                    title="Document available offline"></div>
                }
                @case (DocumentSyncState.Syncing) {
                  <div
                    class="connection-status syncing"
                    title="Syncing with server..."></div>
                }
                @case (DocumentSyncState.Synced) {
                  <div
                    class="connection-status synced"
                    title="Connected and synced"></div>
                }
              }
              <button
                mat-icon-button
                (click)="closeTab(i); $event.stopPropagation()">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </ng-template>
          @if (file.type === 'IMAGE') {
            <app-image-element-editor
              [elementId]="file.id"></app-image-element-editor>
          } @else {
            <app-document-element-editor
              [documentId]="file.id"></app-document-element-editor>
          }
        </mat-tab>
      }
    </mat-tab-group>
  </mat-sidenav-content>
</mat-sidenav-container>
