<div class="setup-container">
  <div class="setup-content">
    <mat-card class="setup-card" data-testid="setup-card">
      <mat-card-header>
        <mat-card-title>
          @if (
            (showServerSetup() || showLocalSetup()) && appMode() === 'BOTH'
          ) {
            <button
              mat-icon-button
              (click)="goBack()"
              class="title-icon-button"
              data-testid="back-button">
              <mat-icon>arrow_back</mat-icon>
            </button>
          } @else {
            <mat-icon class="title-icon">settings</mat-icon>
          }
          Welcome to Inkweld
        </mat-card-title>
        <mat-card-subtitle>
          @if (configLoading()) {
            Loading configuration...
          } @else if (shouldShowModeSelection()) {
            Choose how you'd like to use Inkweld
          } @else if (showServerSetup()) {
            Connect to your Inkweld server
          } @else if (showLocalSetup()) {
            Set up your local profile
          }
        </mat-card-subtitle>
      </mat-card-header>

      @if (isLoading() || configLoading()) {
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      }

      <mat-card-content>
        @if (configLoading()) {
          <!-- Configuration loading state -->
          <div style="text-align: center; padding: 48px 24px">
            <mat-icon
              style="
                font-size: 48px;
                width: 48px;
                height: 48px;
                margin-bottom: 16px;
                opacity: 0.6;
              "
              >settings</mat-icon
            >
            <p>Loading system configuration...</p>
          </div>
        } @else if (shouldShowModeSelection()) {
          <!-- Initial choice screen - only shown when appMode is 'BOTH' -->
          <div class="setup-options">
            @if (canUseLocalMode()) {
              <button
                class="option-card"
                (click)="chooseLocalMode()"
                data-testid="local-mode-button">
                <mat-icon class="option-icon">computer</mat-icon>
                <h3>Work Locally</h3>
                <p>
                  Work completely locally with browser storage. All your
                  projects will be stored on your device.
                </p>
                <span class="option-button">Choose Local Mode</span>
              </button>
            }

            @if (canUseServerMode() && canUseLocalMode()) {
              <mat-divider [vertical]="true"></mat-divider>
            }

            @if (canUseServerMode()) {
              <button
                class="option-card"
                (click)="chooseServerMode()"
                data-testid="server-mode-button">
                <mat-icon class="option-icon">cloud</mat-icon>
                <h3>Connect to Server</h3>
                <p>
                  Connect to an Inkweld server for collaboration and cloud sync.
                  Perfect for teams and shared projects.
                </p>
                <span class="option-button">Choose Server Mode</span>
              </button>
            }
          </div>
        }

        @if (showServerSetup()) {
          <!-- Server setup form -->
          <div class="setup-form">
            <div class="field-row">
              <mat-form-field appearance="outline">
                <mat-label>Server URL</mat-label>
                <input
                  matInput
                  [(ngModel)]="serverUrl"
                  placeholder="http://localhost:8333"
                  type="url"
                  required
                  data-testid="server-url-input" />
                <mat-icon matSuffix>link</mat-icon>
              </mat-form-field>
              <p class="field-hint">
                The address of your Inkweld server for syncing projects and
                collaboration.
              </p>
            </div>
          </div>
        }

        @if (showLocalSetup()) {
          <!-- Local setup form -->
          <div class="setup-form">
            <div class="field-row">
              <mat-form-field appearance="outline">
                <mat-label>Username</mat-label>
                <input
                  matInput
                  [(ngModel)]="userName"
                  placeholder="local"
                  data-testid="local-username-input" />
                <mat-icon matSuffix>person</mat-icon>
              </mat-form-field>
              <p class="field-hint">
                Optional. Defaults to "local". Used for project paths and if you
                later connect to a server. You can change this in settings.
              </p>
            </div>

            <div class="field-row">
              <mat-form-field appearance="outline">
                <mat-label>Display Name</mat-label>
                <input
                  matInput
                  [(ngModel)]="displayName"
                  placeholder="Local User"
                  data-testid="local-displayname-input" />
                <mat-icon matSuffix>badge</mat-icon>
              </mat-form-field>
              <p class="field-hint">
                Optional. Defaults to "Local User". How your name appears in the
                app. Can be changed later in settings.
              </p>
            </div>
          </div>
        }
      </mat-card-content>

      @if (showServerSetup()) {
        <mat-card-actions align="end">
          <button
            mat-raised-button
            color="primary"
            (click)="setupServerMode()"
            [disabled]="isLoading() || !serverUrl.trim()"
            data-testid="connect-server-button">
            Connect to Server
          </button>
        </mat-card-actions>
      }

      @if (showLocalSetup()) {
        <mat-card-actions align="end">
          <button
            mat-raised-button
            color="accent"
            (click)="setupLocalMode()"
            [disabled]="isLoading()"
            data-testid="start-local-button">
            Start Local Mode
          </button>
        </mat-card-actions>
      }
    </mat-card>
  </div>

  <!-- Theme toggle in bottom right corner -->
  <div class="theme-toggle-container">
    <app-theme-toggle></app-theme-toggle>
  </div>
</div>
