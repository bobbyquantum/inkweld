<div class="setup-container">
  <div class="setup-content">
    <mat-card class="setup-card" data-testid="setup-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>settings</mat-icon>
          Welcome to Inkweld
        </mat-card-title>
        <mat-card-subtitle>
          @if (configLoading()) {
            Loading configuration...
          } @else if (shouldShowModeSelection()) {
            Choose how you'd like to use Inkweld
          } @else if (showServerSetup()) {
            Connect to your Inkweld server
          } @else if (showOfflineSetup()) {
            Set up your offline profile
          }
        </mat-card-subtitle>
      </mat-card-header>

      @if (isLoading() || configLoading()) {
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      }

      <mat-card-content>
        @if (configLoading()) {
          <!-- Configuration loading state -->
          <div style="text-align: center; padding: 48px 24px">
            <mat-icon
              style="
                font-size: 48px;
                width: 48px;
                height: 48px;
                margin-bottom: 16px;
                opacity: 0.6;
              "
              >settings</mat-icon
            >
            <p>Loading system configuration...</p>
          </div>
        } @else if (shouldShowModeSelection()) {
          <!-- Initial choice screen - only shown when appMode is 'BOTH' -->
          <div class="setup-options">
            @if (canUseServerMode()) {
              <button
                class="option-card"
                (click)="chooseServerMode()"
                data-testid="server-mode-button">
                <mat-icon class="option-icon">cloud</mat-icon>
                <h3>Connect to Server</h3>
                <p>
                  Connect to an Inkweld server for collaboration and cloud sync.
                  Perfect for teams and shared projects.
                </p>
                <span class="option-button">Choose Server Mode</span>
              </button>
            }

            @if (canUseServerMode() && canUseOfflineMode()) {
              <mat-divider [vertical]="true"></mat-divider>
            }

            @if (canUseOfflineMode()) {
              <button
                class="option-card"
                (click)="chooseOfflineMode()"
                data-testid="offline-mode-button">
                <mat-icon class="option-icon">offline_bolt</mat-icon>
                <h3>Work Offline</h3>
                <p>
                  Work completely offline with local storage. All your projects
                  will be stored on your device.
                </p>
                <span class="option-button">Choose Offline Mode</span>
              </button>
            }
          </div>
        }

        @if (showServerSetup()) {
          <!-- Server setup form -->
          <div class="setup-form">
            @if (appMode() === 'BOTH') {
              <button
                mat-icon-button
                (click)="goBack()"
                class="back-button"
                data-testid="server-back-button">
                <mat-icon>arrow_back</mat-icon>
              </button>
            }

            <h3>Server Configuration</h3>
            <p>Enter the URL of your Inkweld server:</p>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Server URL</mat-label>
              <input
                matInput
                [(ngModel)]="serverUrl"
                placeholder="http://localhost:8333"
                type="url"
                required
                data-testid="server-url-input" />
              <mat-icon matSuffix>link</mat-icon>
            </mat-form-field>

            <div class="form-actions">
              @if (appMode() === 'BOTH') {
                <button mat-button (click)="goBack()">Cancel</button>
              }
              <button
                mat-raised-button
                color="primary"
                (click)="setupServerMode()"
                [disabled]="isLoading() || !serverUrl.trim()"
                data-testid="connect-server-button">
                Connect to Server
              </button>
            </div>
          </div>
        }

        @if (showOfflineSetup()) {
          <!-- Offline setup form -->
          <div class="setup-form">
            @if (appMode() === 'BOTH') {
              <button
                mat-icon-button
                (click)="goBack()"
                class="back-button"
                data-testid="offline-back-button">
                <mat-icon>arrow_back</mat-icon>
              </button>
            }

            <h3>Offline Profile Setup</h3>
            <p>Create your offline profile:</p>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Username</mat-label>
              <input
                matInput
                [(ngModel)]="userName"
                placeholder="your-username"
                required
                data-testid="offline-username-input" />
              <mat-icon matSuffix>person</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Display Name</mat-label>
              <input
                matInput
                [(ngModel)]="displayName"
                placeholder="Your Name"
                required
                data-testid="offline-displayname-input" />
              <mat-icon matSuffix>badge</mat-icon>
            </mat-form-field>

            <div class="form-actions">
              @if (appMode() === 'BOTH') {
                <button mat-button (click)="goBack()">Cancel</button>
              }
              <button
                mat-raised-button
                color="accent"
                (click)="setupOfflineMode()"
                [disabled]="
                  isLoading() || !userName.trim() || !displayName.trim()
                "
                data-testid="start-offline-button">
                Start Offline Mode
              </button>
            </div>
          </div>
        }
      </mat-card-content>
    </mat-card>
  </div>
</div>
