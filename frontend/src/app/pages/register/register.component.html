<div class="register-container" [class.mobile]="isMobile">
  <div class="content-wrapper">
    <mat-card>
      <div class="logo-container">
        <img src="/logo.png" alt="Inkweld Logo" class="logo-image" />
      </div>

      <div class="card-content">
        <h2 class="title">Register for Inkweld</h2>

        <form [formGroup]="registerForm" (ngSubmit)="onRegister()">
          <mat-form-field appearance="outline">
            <mat-label>Username</mat-label>
            <input
              matInput
              type="text"
              formControlName="username"
              required
              (blur)="checkUsernameAvailability()"
              aria-label="Username"
              data-testid="username-input" />
            <mat-icon matSuffix>
              @switch (usernameAvailability) {
                @case ('available') {
                  <mat-icon color="primary">check_circle</mat-icon>
                }
                @case ('unavailable') {
                  <mat-icon color="warn">cancel</mat-icon>
                }
              }
            </mat-icon>
            <mat-error>{{ getUsernameErrorMessage() }}</mat-error>
          </mat-form-field>

          @if (usernameSuggestions && usernameSuggestions.length > 0) {
            <div class="username-suggestions">
              <span class="suggestions-label">Available alternatives:</span>
              <div class="suggestions-buttons">
                @for (suggestion of usernameSuggestions; track suggestion) {
                  <button
                    mat-stroked-button
                    color="primary"
                    type="button"
                    (click)="selectSuggestion(suggestion)"
                    class="suggestion-button">
                    {{ suggestion }}
                  </button>
                }
              </div>
            </div>
          }

          <mat-form-field appearance="outline">
            <mat-label>Password</mat-label>
            <input
              #passwordField
              matInput
              type="password"
              formControlName="password"
              required
              (focus)="onPasswordFocus()"
              (blur)="onPasswordBlur()"
              (input)="onPasswordInput($event)"
              aria-label="Password"
              data-testid="password-input" />
            <mat-error>{{ getPasswordErrorMessage() }}</mat-error>
          </mat-form-field>

          @if (
            serverValidationErrors['password'] &&
            serverValidationErrors['password'].length > 0
          ) {
            <div class="password-validation-errors">
              <div class="validation-error-heading">Password requirements:</div>
              <ul class="validation-error-list">
                @for (
                  error of serverValidationErrors['password'];
                  track error
                ) {
                  <li class="validation-error-item">
                    <mat-icon class="validation-error-icon">
                      error_outline
                    </mat-icon>
                    <span>{{ error }}</span>
                  </li>
                }
              </ul>
            </div>
          }

          <mat-form-field appearance="outline">
            <mat-label>Confirm Password</mat-label>
            <input
              matInput
              type="password"
              formControlName="confirmPassword"
              required
              aria-label="Confirm Password"
              data-testid="confirm-password-input" />
            <mat-error>{{ getConfirmPasswordErrorMessage() }}</mat-error>
          </mat-form-field>

          @if (isCaptchaEnabled) {
            <div class="captcha-container">
              <div class="captcha-wrapper">
                <div #recaptchaElement class="recaptcha-element"></div>
                @if (captchaLoading) {
                  <div class="captcha-loading-overlay">
                    <mat-spinner diameter="20"></mat-spinner>
                    <span>Loading verification...</span>
                  </div>
                }
              </div>
              @if (captchaError) {
                <div class="captcha-error">
                  <mat-icon color="warn">error</mat-icon>
                  <span>Please complete the captcha verification</span>
                </div>
              }
            </div>
          }

          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="
              registerForm.invalid || isRegistering || !providersLoaded
            "
            class="register-button"
            data-testid="register-button">
            @if (!isRegistering) {
              <span>Register</span>
            }
            @if (isRegistering) {
              <span>Creating account...</span>
            }
          </button>
        </form>

        <mat-divider></mat-divider>

        <div class="oauth-container">
          <app-oauth-provider-list
            [isRegisterContext]="true"
            (loaded)="onProvidersLoaded()"></app-oauth-provider-list>
        </div>

        <button
          mat-raised-button
          color="primary"
          type="button"
          routerLink="/welcome"
          class="login-button">
          Already have an account? Login here
        </button>
      </div>
    </mat-card>
  </div>
</div>

<!-- Password Requirements Tooltip Template -->
<ng-template #passwordTooltipTemplate>
  <div class="password-requirements-tooltip">
    <div class="tooltip-header">
      <mat-icon class="tooltip-icon">security</mat-icon>
      <span class="tooltip-title">Password Requirements</span>
    </div>
    <ul class="requirements-list">
      @for (
        requirement of passwordRequirements | keyvalue;
        track requirement.key
      ) {
        <li class="requirement-item" [class.met]="requirement.value.met">
          <mat-icon class="requirement-icon">
            {{ requirement.value.met ? 'check_circle' : 'cancel' }}
          </mat-icon>
          <span class="requirement-text">{{ requirement.value.message }}</span>
        </li>
      }
    </ul>
  </div>
</ng-template>
