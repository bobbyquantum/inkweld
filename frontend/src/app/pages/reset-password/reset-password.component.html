<div class="reset-password-container" data-testid="reset-password-page">
  <mat-card class="reset-password-card">
    <mat-card-content>
      @if (noToken()) {
        <div class="error-container" data-testid="no-token-error">
          <mat-icon class="error-icon-large">error_outline</mat-icon>
          <h2>Invalid Link</h2>
          <p>
            This password reset link is invalid. Please request a new one from
            the login page.
          </p>
          <a routerLink="/forgot-password" mat-raised-button color="primary">
            Request New Link
          </a>
        </div>
      } @else if (success()) {
        <div class="success-container" data-testid="reset-success">
          <mat-icon class="success-icon">check_circle</mat-icon>
          <h2>Password Reset Complete</h2>
          <p>
            Your password has been successfully changed. You can now log in with
            your new password.
          </p>
          <a routerLink="/" mat-raised-button color="primary">Go to Login</a>
        </div>
      } @else {
        <div class="card-header">
          <mat-icon class="header-icon">lock</mat-icon>
          <h2>Set New Password</h2>
          <p class="subtitle">Enter your new password below.</p>
        </div>

        <form (ngSubmit)="onSubmit()" data-testid="reset-password-form">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>New Password</mat-label>
            <input
              matInput
              type="password"
              [(ngModel)]="newPassword"
              (input)="onPasswordInput()"
              name="newPassword"
              required
              data-testid="new-password-input"
              aria-label="New password" />
          </mat-form-field>

          <!-- Password Requirements -->
          <ul class="password-requirements" data-testid="password-requirements">
            @for (
              requirement of passwordRequirements | keyvalue;
              track requirement.key
            ) {
              @if (requirement.value.enabled) {
                <li
                  class="requirement-item"
                  [class.met]="requirement.value.met"
                  [class.unmet]="
                    newPassword.length > 0 && !requirement.value.met
                  ">
                  <mat-icon class="requirement-icon">
                    {{
                      requirement.value.met
                        ? 'check_circle'
                        : 'radio_button_unchecked'
                    }}
                  </mat-icon>
                  <span>{{ requirement.value.message }}</span>
                </li>
              }
            }
          </ul>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Confirm Password</mat-label>
            <input
              matInput
              type="password"
              [(ngModel)]="confirmPassword"
              name="confirmPassword"
              required
              data-testid="confirm-password-input"
              aria-label="Confirm new password" />
          </mat-form-field>

          @if (confirmPassword && newPassword !== confirmPassword) {
            <div class="error-message" data-testid="password-validation-error">
              <mat-icon>error_outline</mat-icon>
              <span>Passwords do not match</span>
            </div>
          }

          @if (error()) {
            <div class="error-message" data-testid="reset-error">
              <mat-icon>error_outline</mat-icon>
              <span>{{ error() }}</span>
            </div>
          }

          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="isSubmitting() || !isFormValid()"
            class="submit-button"
            data-testid="reset-submit-button">
            @if (isSubmitting()) {
              <mat-spinner diameter="18" class="button-spinner"></mat-spinner>
            } @else {
              Reset Password
            }
          </button>
        </form>
      }

      <div class="back-link">
        <a routerLink="/" data-testid="back-to-home">Back to home</a>
      </div>
    </mat-card-content>
  </mat-card>
</div>
