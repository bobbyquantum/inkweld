<div
  class="worldbuilding-editor-container"
  data-testid="worldbuilding-editor"
  [class.panel-open]="showMetaPanel()">
  <div class="editor-section">
    <div class="dynamic-worldbuilding-editor">
      @if (schema()) {
        <form [formGroup]="form">
          <!-- Toolbar with template editing and meta panel toggle -->
          <div class="template-editor-controls">
            <button
              mat-stroked-button
              type="button"
              data-testid="edit-template-button"
              (click)="editEmbeddedTemplate()">
              <mat-icon>edit</mat-icon>
              Edit Template
            </button>
            <!-- Meta panel toggle button -->
            <button
              mat-icon-button
              class="meta-panel-toggle-btn"
              (click)="showMetaPanel.set(!showMetaPanel())"
              [matTooltip]="showMetaPanel() ? 'Hide panel' : 'Show panel'"
              data-testid="meta-panel-toggle">
              <mat-icon>{{
                showMetaPanel() ? 'chevron_right' : 'chevron_left'
              }}</mat-icon>
            </button>
          </div>

          <mat-tab-group>
            @for (tab of getTabs(); track tab.key) {
              <mat-tab [label]="tab.label">
                <div class="tab-content">
                  @for (field of getFieldsForTab(tab.key); track field.key) {
                    @if (field.key.includes('.')) {
                      <!-- Nested field (e.g., appearance.height) -->
                      <div
                        [formGroupName]="field.key.split('.')[0]"
                        class="field-container"
                        [attr.data-testid]="'field-' + field.key"
                        [ngClass]="'span-' + (field.layout?.span || 12)">
                        @switch (field.type) {
                          @case ('text') {
                            <mat-form-field
                              appearance="outline"
                              class="full-width">
                              <mat-label>{{ field.label }}</mat-label>
                              <input
                                matInput
                                [formControlName]="field.key.split('.')[1]"
                                [placeholder]="field.placeholder || ''" />
                              @if (field.description) {
                                <mat-hint>{{ field.description }}</mat-hint>
                              }
                            </mat-form-field>
                          }

                          @case ('textarea') {
                            <mat-form-field
                              appearance="outline"
                              class="full-width">
                              <mat-label>{{ field.label }}</mat-label>
                              <textarea
                                matInput
                                [formControlName]="field.key.split('.')[1]"
                                [placeholder]="field.placeholder || ''"
                                [rows]="field.rows || 3"></textarea>
                              @if (field.description) {
                                <mat-hint>{{ field.description }}</mat-hint>
                              }
                            </mat-form-field>
                          }

                          @case ('number') {
                            <mat-form-field
                              appearance="outline"
                              class="full-width">
                              <mat-label>{{ field.label }}</mat-label>
                              <input
                                matInput
                                type="number"
                                [formControlName]="field.key.split('.')[1]"
                                [placeholder]="field.placeholder || ''" />
                              @if (field.description) {
                                <mat-hint>{{ field.description }}</mat-hint>
                              }
                            </mat-form-field>
                          }

                          @case ('select') {
                            <mat-form-field
                              appearance="outline"
                              class="full-width">
                              <mat-label>{{ field.label }}</mat-label>
                              <mat-select
                                [formControlName]="field.key.split('.')[1]">
                                @for (option of field.options; track option) {
                                  <mat-option [value]="option">{{
                                    option
                                  }}</mat-option>
                                }
                              </mat-select>
                              @if (field.description) {
                                <mat-hint>{{ field.description }}</mat-hint>
                              }
                            </mat-form-field>
                          }
                        }
                      </div>
                    } @else {
                      <!-- Top-level field -->
                      <div
                        class="field-container"
                        [attr.data-testid]="'field-' + field.key"
                        [ngClass]="'span-' + (field.layout?.span || 12)">
                        @switch (field.type) {
                          @case ('text') {
                            <mat-form-field
                              appearance="outline"
                              class="full-width">
                              <mat-label>{{ field.label }}</mat-label>
                              <input
                                matInput
                                [formControlName]="field.key"
                                [placeholder]="field.placeholder || ''" />
                              @if (field.description) {
                                <mat-hint>{{ field.description }}</mat-hint>
                              }
                            </mat-form-field>
                          }

                          @case ('textarea') {
                            <mat-form-field
                              appearance="outline"
                              class="full-width">
                              <mat-label>{{ field.label }}</mat-label>
                              <textarea
                                matInput
                                [formControlName]="field.key"
                                [placeholder]="field.placeholder || ''"
                                [rows]="field.rows || 3"></textarea>
                              @if (field.description) {
                                <mat-hint>{{ field.description }}</mat-hint>
                              }
                            </mat-form-field>
                          }

                          @case ('number') {
                            <mat-form-field
                              appearance="outline"
                              class="full-width">
                              <mat-label>{{ field.label }}</mat-label>
                              <input
                                matInput
                                type="number"
                                [formControlName]="field.key"
                                [placeholder]="field.placeholder || ''" />
                              @if (field.description) {
                                <mat-hint>{{ field.description }}</mat-hint>
                              }
                            </mat-form-field>
                          }

                          @case ('select') {
                            <mat-form-field
                              appearance="outline"
                              class="full-width">
                              <mat-label>{{ field.label }}</mat-label>
                              <mat-select [formControlName]="field.key">
                                @for (option of field.options; track option) {
                                  <mat-option [value]="option">{{
                                    option
                                  }}</mat-option>
                                }
                              </mat-select>
                              @if (field.description) {
                                <mat-hint>{{ field.description }}</mat-hint>
                              }
                            </mat-form-field>
                          }

                          @case ('array') {
                            <div class="array-field">
                              <h4>{{ field.label }}</h4>
                              @if (field.description) {
                                <p class="field-description">
                                  {{ field.description }}
                                </p>
                              }

                              @for (
                                control of getFormArray(field.key).controls;
                                track $index
                              ) {
                                <div class="array-item">
                                  <mat-form-field appearance="outline">
                                    <input
                                      matInput
                                      [formControl]="$any(control)"
                                      [placeholder]="
                                        field.placeholder || 'Add item'
                                      " />
                                  </mat-form-field>
                                  <button
                                    mat-icon-button
                                    color="warn"
                                    type="button"
                                    (click)="
                                      removeArrayItem(field.key, $index)
                                    ">
                                    <mat-icon>delete</mat-icon>
                                  </button>
                                </div>
                              }

                              <button
                                mat-raised-button
                                type="button"
                                (click)="addArrayItem(field.key)">
                                <mat-icon>add</mat-icon> Add {{ field.label }}
                              </button>
                            </div>
                          }
                        }
                      </div>
                    }
                  }
                </div>
              </mat-tab>
            }
          </mat-tab-group>
        </form>
      } @else {
        <div class="loading-state">
          <mat-icon>hourglass_empty</mat-icon>
          <p>Loading schema...</p>
        </div>
      }
    </div>
  </div>

  <!-- Meta Panel (Relationships + Snapshots) -->
  <div class="meta-panel-container" [class.open]="showMetaPanel()">
    <app-meta-panel
      [documentId]="elementId()"
      [elementId]="elementId()"
      [isOpen]="showMetaPanel()"
      (openChange)="showMetaPanel.set($event)">
    </app-meta-panel>
  </div>
</div>
