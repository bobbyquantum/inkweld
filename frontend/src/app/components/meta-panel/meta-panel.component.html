@if (isOpen()) {
  <div class="meta-panel">
    <div class="panel-content">
      <!-- Add Relationship Button - Always visible at top -->
      <div class="panel-actions">
        <button
          mat-stroked-button
          (click)="openAddRelationshipDialog()"
          class="add-relationship-button"
          data-testid="add-relationship-button">
          <mat-icon>add</mat-icon>
          <span>Add Relationship</span>
        </button>
      </div>

      <!-- ARIA Accordion for relationship groups -->
      <div
        ngAccordionGroup
        class="relationships-accordion"
        [multiExpandable]="true">
        @for (group of groupedRelationships(); track getGroupKey(group)) {
          <div class="accordion-section" [class.incoming]="group.isIncoming">
            <h3 class="accordion-header">
              <span
                ngAccordionTrigger
                [panelId]="getGroupKey(group)"
                #trigger="ngAccordionTrigger"
                [expanded]="true"
                class="accordion-trigger"
                data-testid="relationship-type-panel">
                <span class="trigger-content">
                  <mat-icon class="section-icon">{{
                    group.type.icon || 'link'
                  }}</mat-icon>
                  <span class="group-label">{{ group.displayLabel }}</span>
                  <span class="group-count"
                    >({{ group.relationships.length }})</span
                  >
                </span>
                <mat-icon
                  class="expand-icon"
                  [class.expanded]="trigger.expanded()">
                  keyboard_arrow_up
                </mat-icon>
              </span>
            </h3>
            <div ngAccordionPanel [panelId]="getGroupKey(group)">
              <ng-template ngAccordionContent>
                <ul class="relationships-list" role="list">
                  @for (rel of group.relationships; track rel.id) {
                    <li
                      class="relationship-item"
                      data-testid="relationship-item"
                      (mouseenter)="
                        showTooltipForElement(
                          group.isIncoming
                            ? rel.sourceElementId
                            : rel.targetElementId,
                          $event
                        )
                      "
                      (mouseleave)="hideTooltip()">
                      <button
                        type="button"
                        class="item-button"
                        (click)="navigateToElement(rel, group.isIncoming)"
                        (keydown.enter)="
                          navigateToElement(rel, group.isIncoming)
                        ">
                        <mat-icon class="item-icon">{{
                          getElementIcon(
                            group.isIncoming
                              ? rel.sourceElementId
                              : rel.targetElementId
                          )
                        }}</mat-icon>
                        <span class="item-name">{{
                          getElementName(
                            group.isIncoming
                              ? rel.sourceElementId
                              : rel.targetElementId
                          )
                        }}</span>
                      </button>
                      <button
                        mat-icon-button
                        [matMenuTriggerFor]="relationshipMenu"
                        class="menu-button"
                        data-testid="relationship-menu-button">
                        <mat-icon>more_vert</mat-icon>
                      </button>
                      <mat-menu #relationshipMenu="matMenu">
                        <button
                          mat-menu-item
                          (click)="navigateToElement(rel, group.isIncoming)">
                          <mat-icon>open_in_new</mat-icon>
                          <span>Go to element</span>
                        </button>
                        @if (!group.isIncoming) {
                          <button
                            mat-menu-item
                            (click)="deleteRelationship(rel, $event)"
                            data-testid="delete-relationship-button">
                            <mat-icon color="warn">delete</mat-icon>
                            <span>Remove relationship</span>
                          </button>
                        }
                      </mat-menu>
                    </li>
                  }
                </ul>
              </ng-template>
            </div>
          </div>
        }
      </div>
    </div>
  </div>
}
