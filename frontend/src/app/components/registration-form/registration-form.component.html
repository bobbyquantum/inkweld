<form
  [formGroup]="registerForm"
  (ngSubmit)="submit()"
  class="registration-form"
  [class.compact]="compact"
  data-testid="registration-form">
  <mat-form-field appearance="outline">
    <mat-label>Username</mat-label>
    <input
      matInput
      type="text"
      formControlName="username"
      required
      (blur)="checkUsernameAvailability()"
      aria-label="Username"
      [attr.data-testid]="testIdPrefix + 'username-input'" />
    @switch (usernameAvailability) {
      @case ('available') {
        <mat-icon
          matSuffix
          color="primary"
          data-testid="username-available-icon"
          >check_circle</mat-icon
        >
      }
      @case ('unavailable') {
        <mat-icon matSuffix color="warn" data-testid="username-unavailable-icon"
          >cancel</mat-icon
        >
      }
    }
    <mat-error data-testid="username-error">{{
      getUsernameErrorMessage()
    }}</mat-error>
  </mat-form-field>

  @if (usernameSuggestions && usernameSuggestions.length > 0) {
    <div class="username-suggestions" data-testid="username-suggestions">
      <span class="suggestions-label">Available alternatives:</span>
      <div class="suggestions-buttons">
        @for (suggestion of usernameSuggestions; track suggestion) {
          <button
            mat-stroked-button
            color="primary"
            type="button"
            (click)="selectSuggestion(suggestion)"
            class="suggestion-button"
            data-testid="suggestion-button">
            {{ suggestion }}
          </button>
        }
      </div>
    </div>
  }

  <mat-form-field appearance="outline">
    <mat-label>Display Name</mat-label>
    <input
      matInput
      type="text"
      formControlName="displayName"
      aria-label="Display Name"
      [attr.data-testid]="testIdPrefix + 'display-name-input'" />
    <mat-hint>Optional. Shown instead of username.</mat-hint>
  </mat-form-field>

  <mat-form-field appearance="outline">
    <mat-label>Email Address</mat-label>
    <input
      matInput
      type="email"
      formControlName="email"
      [required]="isRequireEmail()"
      aria-label="Email Address"
      [attr.data-testid]="testIdPrefix + 'email-input'" />
    @if (isRequireEmail()) {
      <mat-hint>Required for password resets and notifications.</mat-hint>
    } @else {
      <mat-hint>Optional. Used for password resets.</mat-hint>
    }
    <mat-error>{{ getEmailErrorMessage() }}</mat-error>
  </mat-form-field>

  <mat-form-field appearance="outline">
    <mat-label>Password</mat-label>
    <input
      #passwordField
      matInput
      type="password"
      formControlName="password"
      required
      (focus)="onPasswordFocus()"
      (blur)="onPasswordBlur()"
      (input)="onPasswordInput($event)"
      aria-label="Password"
      [attr.data-testid]="testIdPrefix + 'password-input'" />
    <mat-error>{{ getPasswordErrorMessage() }}</mat-error>
  </mat-form-field>

  @if (
    serverValidationErrors['password'] &&
    serverValidationErrors['password'].length > 0
  ) {
    <div class="password-validation-errors">
      <div class="validation-error-heading">Password requirements:</div>
      <ul class="validation-error-list">
        @for (error of serverValidationErrors['password']; track error) {
          <li class="validation-error-item">
            <mat-icon class="validation-error-icon">error_outline</mat-icon>
            <span>{{ error }}</span>
          </li>
        }
      </ul>
    </div>
  }

  <mat-form-field appearance="outline">
    <mat-label>Confirm Password</mat-label>
    <input
      matInput
      type="password"
      formControlName="confirmPassword"
      required
      aria-label="Confirm Password"
      [attr.data-testid]="testIdPrefix + 'confirm-password-input'" />
    <mat-error>{{ getConfirmPasswordErrorMessage() }}</mat-error>
  </mat-form-field>

  @if (showSubmitButton) {
    <button
      mat-raised-button
      color="primary"
      type="submit"
      [disabled]="registerForm.invalid || isRegistering()"
      class="submit-button"
      [attr.data-testid]="testIdPrefix + 'register-button'">
      @if (!isRegistering()) {
        <span>{{ submitButtonText }}</span>
      }
      @if (isRegistering()) {
        <mat-spinner diameter="18"></mat-spinner>
        <span>{{ registeringText }}</span>
      }
    </button>
  }
</form>

<!-- Password Requirements Tooltip Template -->
<ng-template #passwordTooltipTemplate>
  <div class="password-requirements-tooltip">
    <div class="tooltip-header">
      <mat-icon class="tooltip-icon">security</mat-icon>
      <span class="tooltip-title">Password Requirements</span>
    </div>
    <ul class="requirements-list">
      @for (
        requirement of passwordRequirements | keyvalue;
        track requirement.key
      ) {
        <li class="requirement-item" [class.met]="requirement.value.met">
          <mat-icon class="requirement-icon">
            {{ requirement.value.met ? 'check_circle' : 'cancel' }}
          </mat-icon>
          <span class="requirement-text">{{ requirement.value.message }}</span>
        </li>
      }
    </ul>
  </div>
</ng-template>
