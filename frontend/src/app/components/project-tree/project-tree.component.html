<div #treeContainer class="project-tree-container" data-testid="project-tree">
  <!-- Loading overlay -->
  @if (isLoading()) {
    <div class="loading-overlay">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
  }

  <!-- Error message -->
  @if (error()) {
    <div class="error-message">
      {{ error() }}
    </div>
  }

  <!-- Toolbar with action buttons -->
  <div class="tree-toolbar">
    @if (showCollapseButton()) {
      <button
        mat-icon-button
        class="collapse-button"
        (click)="collapseRequested.emit()"
        matTooltip="Collapse Sidebar"
        data-testid="toolbar-collapse-button"
        aria-label="Collapse Sidebar">
        <mat-icon fontSet="material-symbols-outlined"
          >left_panel_close</mat-icon
        >
      </button>
    }
    <button
      mat-icon-button
      class="home-button"
      [class.active]="isHomeSelected()"
      (click)="goHome()"
      matTooltip="Home"
      data-testid="toolbar-home-button">
      <mat-icon>home</mat-icon>
    </button>
    <span class="toolbar-spacer"></span>
    @if (projectStateService.canWrite()) {
      <button
        mat-icon-button
        (click)="onCreateNewDocument()"
        matTooltip="New Document"
        data-testid="toolbar-new-document-button">
        <mat-icon>note_add</mat-icon>
      </button>
      <button
        mat-icon-button
        (click)="onCreateNewFolder()"
        matTooltip="New Folder"
        data-testid="toolbar-new-folder-button">
        <mat-icon>create_new_folder</mat-icon>
      </button>
    }
  </div>

  <!-- Project Tree with ARIA attributes for accessibility -->
  <ul
    role="tree"
    class="aria-tree"
    cdkDropList
    [cdkDropListData]="treeElements()"
    (cdkDropListSorted)="sorted($event)"
    (cdkDropListDropped)="drop($event)">
    @for (node of treeElements(); track node.id) {
      <li
        role="treeitem"
        [attr.aria-expanded]="node.expandable ? node.expanded : null"
        [attr.aria-level]="node.level + 1"
        [attr.aria-selected]="node.id === selectedItem?.id"
        [attr.aria-label]="node.name"
        cdkDrag
        [cdkDragData]="node"
        (cdkDragStarted)="dragStarted(node)"
        (cdkDragEnded)="dragEnded()"
        (cdkDragMoved)="dragMove($event)"
        [cdkDragDisabled]="isLoading() || !projectStateService.canWrite()"
        [attr.data-testid]="'element-' + node.name"
        [attr.data-level]="node.level"
        [style.padding-left.px]="node.level * 24 + (node.expandable ? 0 : 16)"
        [class.folder-node]="node.expandable"
        [class.context-item]="node.id === contextItem?.id"
        [class.selected-item]="node.id === selectedItem?.id"
        [class.has-open-tab]="hasOpenTab(node.id)"
        [class.drop-target-folder]="
          draggedNode && node.expandable && targetParentFolderId() === node.id
        "
        (mousedown)="onNodeDown(node)"
        (touchstart)="onNodeDown(node)"
        [cdkContextMenuTriggerFor]="contextMenu"
        (contextmenu)="onContextMenuOpen(node)"
        (cdkContextMenuClosed)="onContextMenuClose()"
        [cdkContextMenuTriggerData]="{ node: node }"
        (click)="
          node.expandable
            ? toggleExpandedClick(node, $event)
            : onOpenDocument(node)
        "
        (touchend)="
          node.expandable
            ? toggleExpandedTouch(node, $event)
            : onOpenDocument(node)
        "
        (keyup.enter)="
          node.expandable ? toggleExpanded(node) : onOpenDocument(node)
        "
        tabindex="0">
        <!-- Expand/collapse button for folders -->
        @if (node.expandable) {
          <button
            mat-icon-button
            type="button"
            data-testid="expand-folder-button"
            (click)="toggleExpandedClick(node, $event)"
            (touchend)="toggleExpandedTouch(node, $event)"
            [disabled]="isLoading()">
            <mat-icon>{{
              node.expanded ? 'expand_more' : 'chevron_right'
            }}</mat-icon>
          </button>
        }

        <!-- Node icon -->
        <app-tree-node-icon
          [isExpandable]="node.expandable"
          [isExpanded]="node.expanded ?? false"
          [type]="node.type"
          [schemaId]="node.schemaId"
          [metadata]="node.metadata">
        </app-tree-node-icon>

        <!-- Node title -->
        <div class="node-title">
          {{ node.name }}
        </div>

        <!-- Drag placeholder (ghost) -->
        <div
          class="drag-placeholder"
          *cdkDragPlaceholder
          [class.folder-node]="node.expandable">
          @if (node.expandable) {
            <button mat-icon-button type="button">
              <mat-icon>{{
                node.expanded ? 'expand_more' : 'chevron_right'
              }}</mat-icon>
            </button>
            <mat-icon>folder</mat-icon>
          } @else {
            <app-tree-node-icon
              [isExpandable]="node.expandable"
              [isExpanded]="node.expanded ?? false"
              [type]="node.type"
              [schemaId]="node.schemaId"
              [metadata]="node.metadata">
            </app-tree-node-icon>
          }
          <div class="node-title">{{ node.name }}</div>
        </div>

        <!-- Drag preview -->
        <div class="drag-preview" *cdkDragPreview>
          <app-tree-node-icon
            [isExpandable]="node.expandable"
            [isExpanded]="node.expanded ?? false"
            [type]="node.type"
            [schemaId]="node.schemaId"
            [metadata]="node.metadata">
          </app-tree-node-icon>
          <div class="node-title">{{ node.name }}</div>
        </div>
      </li>
    }

    <!-- Create new element button at the end of the tree (only for users with write access) -->
    @if (projectStateService.canWrite()) {
      <li
        role="treeitem"
        aria-level="1"
        aria-selected="false"
        class="create-item"
        data-testid="create-new-element"
        tabindex="0"
        (click)="onCreateNewElement()"
        (keyup.enter)="onCreateNewElement()">
        <mat-icon>add</mat-icon>
        <div class="node-title">Create</div>
      </li>
    }
  </ul>
</div>

<!-- Context menu -->
<ng-template #contextMenu let-node="node">
  <div class="context-menu" cdkMenu>
    @if (!node.expandable) {
      <button
        type="button"
        class="context-menu-item"
        cdkMenuItem
        [disabled]="isLoading()"
        (click)="onOpenDocument(node)">
        <mat-icon>open_in_new</mat-icon>
        <span class="context-menu-item-title">Open Document</span>
      </button>
    }
    @if (node.expandable && projectStateService.canWrite()) {
      <button
        type="button"
        class="context-menu-item"
        cdkMenuItem
        data-testid="context-menu-new-element"
        [disabled]="isLoading()"
        (click)="onCreateNewElementInFolder(node)">
        <mat-icon>add</mat-icon>
        <span class="context-menu-item-title">New Element</span>
      </button>
    }
    @if (projectStateService.canWrite()) {
      <button
        type="button"
        class="context-menu-item"
        cdkMenuItem
        [disabled]="isLoading()"
        (click)="onRename(node)">
        <mat-icon>edit_square</mat-icon>
        <span class="context-menu-item-title">Rename</span>
      </button>
      <button
        type="button"
        class="context-menu-item"
        cdkMenuItem
        [disabled]="isLoading()"
        (click)="onDelete(node)">
        <mat-icon>delete</mat-icon>
        <span class="context-menu-item-title">Delete</span>
      </button>
    }
  </div>
</ng-template>
