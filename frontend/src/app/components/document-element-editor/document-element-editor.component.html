<!-- Only render when editor exists -->
@if (editor) {
  <div class="editor-with-panel" [class.panel-open]="showMetaPanel()">
    <!-- Main editor section -->
    <div class="editor-section" [class.no-tabs]="tabsDisabled">
      <!-- Only show toolbar when not in zen mode -->
      @if (!zenMode) {
        <div class="editor-toolbar">
          <ngx-editor-menu
            [editor]="editor"
            [toolbar]="toolbar"
            [colorPresets]="colorPresets">
          </ngx-editor-menu>
          <!-- Meta panel toggle button in toolbar -->
          <button
            mat-icon-button
            class="meta-panel-toggle-btn"
            (click)="showMetaPanel.set(!showMetaPanel())"
            [matTooltip]="showMetaPanel() ? 'Hide panel' : 'Show panel'"
            data-testid="meta-panel-toggle">
            <mat-icon>{{
              showMetaPanel() ? 'chevron_right' : 'chevron_left'
            }}</mat-icon>
          </button>
        </div>
      }
      <div
        class="editor-container fit-width"
        [class.zen-mode-container]="zenMode">
        <div class="scaled-content">
          <div class="editor-wrapper">
            @if (editorKey > 0) {
              <ngx-editor
                [editor]="editor"
                [placeholder]="'Type here...'"
                class="editor-content">
                <ngx-editor-floating-menu [editor]="editor">
                  @if (isCursorInLintSuggestion()) {
                    <app-lint-floating-menu
                      [editor]="editor"></app-lint-floating-menu>
                  }
                  @if (!isCursorInLintSuggestion()) {
                    <ngx-editor-menu
                      [editor]="editor"
                      [toolbar]="floatToolbar"
                      [colorPresets]="colorPresets">
                    </ngx-editor-menu>
                  }
                </ngx-editor-floating-menu>
              </ngx-editor>
            }
          </div>
        </div>
      </div>
      <!-- Status bar showing word count and sync status -->
      @if (!zenMode) {
        <div class="editor-status-bar">
          <span>Words: {{ wordCount() }}</span>
          <span class="sync-status">
            <span class="sync-dot {{ syncState() }}"></span>
            {{ syncState() }}
          </span>
        </div>
      }
    </div>

    <!-- Meta Panel (Relationships + Snapshots) - at same level as editor section -->
    <div class="meta-panel-container" [class.open]="showMetaPanel()">
      <app-meta-panel
        [documentId]="documentId"
        [elementId]="null"
        [isOpen]="showMetaPanel()"
        (openChange)="showMetaPanel.set($event)">
      </app-meta-panel>
    </div>
  </div>

  <!-- Element Reference Popup (@ mentions) -->
  @if (elementRefService.isPopupOpen()) {
    <app-element-ref-popup
      [position]="elementRefService.popupPosition()!"
      [initialQuery]="elementRefService.searchQuery()"
      (selected)="onElementSelected($event)"
      (closed)="elementRefService.closePopup()">
    </app-element-ref-popup>
  }

  <!-- Element Reference Context Menu (right-click / long-press) -->
  <app-element-ref-context-menu
    [contextData]="contextMenuData()"
    (action)="onContextMenuAction($event)">
  </app-element-ref-context-menu>

  <!-- Element Reference Tooltip (hover) -->
  <app-element-ref-tooltip [tooltipData]="tooltipData()">
  </app-element-ref-tooltip>
}
