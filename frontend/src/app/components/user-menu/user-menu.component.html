<div class="menu-container">
  <button
    mat-icon-button
    [matMenuTriggerFor]="menu"
    class="user-menu mini-mode"
    aria-label="User menu"
    data-testid="user-menu-button">
    <app-user-avatar
      [username]="userService.currentUser().username"
      [hasAvatar]="userService.currentUser().hasAvatar"
      size="small" />
  </button>

  <mat-menu
    #menu="matMenu"
    yPosition="below"
    class="menu-popover"
    backdropClass="menu-backdrop">
    @if (userService.currentUser()) {
      <div class="user-menu-header">
        <button
          class="user-info"
          mat-menu-item
          [routerLink]="['/', userService.currentUser().username]">
          <div class="user-info-content">
            <app-user-avatar
              [username]="userService.currentUser().username"
              [hasAvatar]="userService.currentUser().hasAvatar"
              size="small" />
            <div class="user-details">
              <span class="user-name">{{
                userService.currentUser().name
              }}</span>
              <span class="user-username"
                >&#64;{{ userService.currentUser().username }}</span
              >
            </div>
          </div>
        </button>
      </div>
      <mat-divider></mat-divider>
      <!-- Server/Profile Switcher - Always visible -->
      <button
        mat-menu-item
        [matMenuTriggerFor]="profileMenu"
        class="switch-server-trigger"
        data-testid="switch-server-button">
        <mat-icon>{{ getConnectionStatus().icon }}</mat-icon>
        <div class="server-info-content">
          <span class="server-label">{{ getCurrentServerName() }}</span>
          <span class="server-sublabel">{{ getConnectionStatus().text }}</span>
        </div>
        <mat-icon class="menu-arrow">arrow_right</mat-icon>
      </button>
      <mat-divider></mat-divider>
      <div class="menu-actions">
        <!-- Theme Selection -->
        <div class="theme-selector">
          <span class="theme-label">Theme:</span>
          <button
            mat-icon-button
            (click)="onThemeChange('light-theme')"
            matTooltip="Light theme"
            data-testid="theme-light-button">
            <mat-icon>light_mode</mat-icon>
          </button>
          <button
            mat-icon-button
            (click)="onThemeChange('dark-theme')"
            matTooltip="Dark theme"
            data-testid="theme-dark-button">
            <mat-icon>dark_mode</mat-icon>
          </button>
          <button
            mat-icon-button
            (click)="onThemeChange('system')"
            matTooltip="Follow system"
            data-testid="theme-system-button">
            <mat-icon>brightness_auto</mat-icon>
          </button>
        </div>
        <mat-divider></mat-divider>
        @if (isAdmin()) {
          <button
            mat-menu-item
            routerLink="/admin"
            data-testid="admin-menu-link">
            <mat-icon>admin_panel_settings</mat-icon>
            <span>Admin</span>
          </button>
        }
        @if (setupService.getMode() === 'server') {
          <button
            mat-menu-item
            routerLink="/messages"
            data-testid="messages-menu-link">
            <mat-icon
              [matBadge]="unreadCount()"
              [matBadgeHidden]="unreadCount() === 0"
              matBadgeColor="warn"
              matBadgeSize="small"
              aria-hidden="false">
              mail
            </mat-icon>
            <span>Messages</span>
          </button>
        }
        <button mat-menu-item (click)="onSettings()">
          <mat-icon>settings</mat-icon>
          <span>Settings</span>
        </button>
        <button mat-menu-item routerLink="/about" data-testid="about-menu-link">
          <mat-icon>info</mat-icon>
          <span>About</span>
        </button>
        @if (setupService.getMode() === 'server') {
          <button mat-menu-item (click)="onLogout()">
            <mat-icon>exit_to_app</mat-icon>
            <span>Log out</span>
          </button>
        } @else {
          <button mat-menu-item routerLink="/reset">
            <mat-icon>restart_alt</mat-icon>
            <span>Reset App</span>
          </button>
        }
      </div>
    }
  </mat-menu>

  <!-- Server/Profile Switcher Submenu -->
  <mat-menu #profileMenu="matMenu" class="profile-submenu">
    <div class="profile-menu-header">
      <span>Switch Server</span>
    </div>
    @for (profile of profiles(); track profile.id) {
      @let display = getProfileDisplay(profile);
      <button
        mat-menu-item
        (click)="onSwitchProfile(profile)"
        [class.active-profile]="display.isActive"
        [attr.data-testid]="'profile-' + profile.id">
        <mat-icon>{{ display.icon }}</mat-icon>
        <div class="profile-item-content">
          <span class="profile-name">{{ display.name }}</span>
          <span class="profile-subtitle">
            @if (display.isActive) {
              <mat-icon class="active-indicator">check</mat-icon>
            }
            {{ display.subtitle }}
            @if (!display.hasAuth && profile.type === 'server') {
              <span class="needs-login">(login required)</span>
            }
          </span>
        </div>
      </button>
    }
    <mat-divider></mat-divider>
    <button
      mat-menu-item
      (click)="onManageProfiles()"
      data-testid="manage-profiles-button">
      <mat-icon>settings</mat-icon>
      <span>Manage Profiles...</span>
    </button>
  </mat-menu>
</div>
