<div class="menu-container">
  <button
    mat-icon-button
    [matMenuTriggerFor]="menu"
    class="user-menu mini-mode"
    aria-label="User menu"
    data-testid="user-menu-button">
    <app-user-avatar
      [username]="userService.currentUser().username"
      [hasAvatar]="userService.currentUser().hasAvatar"
      size="small" />
  </button>

  <mat-menu
    #menu="matMenu"
    yPosition="below"
    class="menu-popover"
    backdropClass="menu-backdrop">
    @if (userService.currentUser()) {
      <div class="user-menu-header">
        <button
          class="user-info"
          mat-menu-item
          [routerLink]="['/', userService.currentUser().username]">
          <div class="user-info-content">
            <app-user-avatar
              [username]="userService.currentUser().username"
              [hasAvatar]="userService.currentUser().hasAvatar"
              size="small" />
            <div class="user-details">
              <span class="user-name">{{
                userService.currentUser().name
              }}</span>
              <span class="user-username"
                >&#64;{{ userService.currentUser().username }}</span
              >
            </div>
          </div>
        </button>
        <div class="connection-status" [class]="getConnectionStatus().cssClass">
          <mat-icon>{{ getConnectionStatus().icon }}</mat-icon>
          <span>{{ getConnectionStatus().text }}</span>
        </div>
      </div>
      <mat-divider></mat-divider>
      <div class="menu-actions">
        <!-- Theme Selection -->
        <div class="theme-selector">
          <span class="theme-label">Theme:</span>
          <button
            mat-icon-button
            (click)="onThemeChange('light-theme')"
            matTooltip="Light theme"
            data-testid="theme-light-button">
            <mat-icon>light_mode</mat-icon>
          </button>
          <button
            mat-icon-button
            (click)="onThemeChange('dark-theme')"
            matTooltip="Dark theme"
            data-testid="theme-dark-button">
            <mat-icon>dark_mode</mat-icon>
          </button>
          <button
            mat-icon-button
            (click)="onThemeChange('system')"
            matTooltip="Follow system"
            data-testid="theme-system-button">
            <mat-icon>brightness_auto</mat-icon>
          </button>
        </div>
        <mat-divider></mat-divider>
        @if (isAdmin()) {
          <button
            mat-menu-item
            routerLink="/admin"
            data-testid="admin-menu-link">
            <mat-icon>admin_panel_settings</mat-icon>
            <span>Admin</span>
          </button>
        }
        @if (setupService.getMode() === 'server') {
          <button
            mat-menu-item
            routerLink="/messages"
            data-testid="messages-menu-link">
            <mat-icon
              [matBadge]="unreadCount()"
              [matBadgeHidden]="unreadCount() === 0"
              matBadgeColor="warn"
              matBadgeSize="small"
              aria-hidden="false">
              mail
            </mat-icon>
            <span>Messages</span>
          </button>
        }
        <button mat-menu-item (click)="onSettings()">
          <mat-icon>settings</mat-icon>
          <span>Settings</span>
        </button>
        <button mat-menu-item routerLink="/about" data-testid="about-menu-link">
          <mat-icon>info</mat-icon>
          <span>About</span>
        </button>
        @if (setupService.getMode() === 'server') {
          <button mat-menu-item (click)="onLogout()">
            <mat-icon>exit_to_app</mat-icon>
            <span>Log out</span>
          </button>
        } @else {
          <button mat-menu-item routerLink="/reset">
            <mat-icon>restart_alt</mat-icon>
            <span>Reset App</span>
          </button>
        }
      </div>
    }
  </mat-menu>
</div>
