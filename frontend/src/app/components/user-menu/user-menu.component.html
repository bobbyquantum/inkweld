<div class="menu-container">
  <button
    mat-icon-button
    [matMenuTriggerFor]="menu"
    class="user-menu mini-mode"
    aria-label="User menu"
    data-testid="user-menu-button">
    <app-user-avatar
      [username]="userService.currentUser()!.username"
      size="small" />
  </button>

  <mat-menu
    #menu="matMenu"
    yPosition="below"
    class="menu-popover"
    backdropClass="menu-backdrop">
    @if (userService.currentUser()) {
      <div class="user-menu-header">
        <button
          class="user-info"
          mat-menu-item
          [routerLink]="['/', userService.currentUser()!.username]">
          <div class="user-info-content">
            <app-user-avatar
              [username]="userService.currentUser()!.username"
              size="small" />
            <div class="user-details">
              <span class="user-name">{{
                userService.currentUser().name
              }}</span>
              <span class="user-username"
                >&#64;{{ userService.currentUser().username }}</span
              >
            </div>
          </div>
        </button>
        <div class="connection-status" [class]="getConnectionStatus().cssClass">
          <mat-icon>{{ getConnectionStatus().icon }}</mat-icon>
          <span>{{ getConnectionStatus().text }}</span>
        </div>
      </div>
      <mat-divider></mat-divider>
      <div class="menu-actions">
        @if (isAdmin()) {
          <button
            mat-menu-item
            routerLink="/admin"
            data-testid="admin-menu-link">
            <mat-icon>admin_panel_settings</mat-icon>
            <span>Admin</span>
          </button>
        }
        <button mat-menu-item (click)="onSettings()">
          <mat-icon>settings</mat-icon>
          <span>Settings</span>
        </button>
        <button mat-menu-item (click)="onLogout()">
          <mat-icon>exit_to_app</mat-icon>
          <span>Log out</span>
        </button>
      </div>
    }
  </mat-menu>
</div>
